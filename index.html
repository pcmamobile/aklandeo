<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>PCMA Mobile V3.1</title>

<link rel="icon" type="image/png" sizes="32x32" href="https://i.ibb.co/RRJpHk2/PCMA-logo-1.png">
<link rel="apple-touch-icon" sizes="180x180" href="https://i.ibb.co/RRJpHk2/PCMA-logo-1.png">
<link rel="manifest" href="manifest.json" />
<meta name="theme-color" content="#2563eb" />

<style>
  :root{
    --brand:#2563eb;
    --brand-dark:#1e40af;
    --bg:#f4f6f8;
    --card:#ffffff;
    --text:#0f172a;
  }
  body{font-family:"Segoe UI",Arial,sans-serif;margin:0;background:var(--bg);color:var(--text);}

  /* ===== DESKTOP HEADER (HIDDEN ON MOBILE / APP) ===== */
  header{
    background:linear-gradient(135deg,var(--brand),var(--brand-dark));
    color:white;padding:12px 16px;border-bottom:3px solid #1e3a8a;
    position:sticky;top:0;z-index:200;
  }
  .header-container{display:flex;align-items:center;justify-content:space-between;gap:12px;max-width:1100px;margin:0 auto;}
  .brand{display:flex;align-items:center;gap:12px;}
  .header-logo{height:70px;width:auto;border-radius:10px;box-shadow:0 3px 6px rgba(0,0,0,0.25);} 
  .header-title{margin:0;font-size:1.8rem;font-weight:700;letter-spacing:.5px;}

  /* ===== ALWAYS VISIBLE QUICK SEARCH ===== */
  .search-top{
    max-width:1100px;margin:10px auto 6px;
    display:flex;gap:10px;align-items:center;
    padding:0 6px;
  }
  .search-toggle{
    background:var(--brand);border:none;color:#fff;font-weight:800;
    padding:9px 16px;border-radius:10px;cursor:pointer;
    white-space:nowrap;
  }
  .search-box-wrap{flex:1;position:relative;}
  #quickSearch{
    width:100%;padding:11px 12px;
    border-radius:10px;border:2px solid #cbd5e1;background:#fff;
    font-size:1rem;outline:none;
  }
  #quickSearch:focus{border-color:var(--brand);box-shadow:0 0 0 3px rgba(37,99,235,.15);}
  .search-hint{
    font-size:.7rem;color:#64748b;margin-left:2px;
  }

  /* ===== ADVANCED FILTERS DROPDOWN ===== */
  #filters{
    display:grid;grid-template-columns:repeat(auto-fit,minmax(210px,1fr));
    gap:12px;margin:0 auto 6px;padding:14px;background:#fff;border-radius:12px;
    box-shadow:0 2px 6px rgba(0,0,0,0.06);border:1px solid #e5e7eb;max-width:1100px;
    transition:opacity .25s ease, max-height .25s ease, margin .25s ease, padding .25s ease, border-width .25s ease;
    opacity:1;max-height:600px;
  }
  #filters.filters-hidden{
    opacity:0;max-height:0;margin:0 auto;padding:0 14px;border-width:0;pointer-events:none;
  }
  #filters label{display:flex;flex-direction:column;gap:6px;font-size:.9rem;color:#0f172a;font-weight:700;}
  #filters select{
    font-size:1rem;padding:10px 12px;border-radius:10px;border:2px solid #cbd5e1;background:#f8fafc;
    outline:none;transition:border-color .15s ease,box-shadow .15s ease; width:100%; box-sizing:border-box;
  }
  #filters select:focus{border-color:var(--brand);box-shadow:0 0 0 3px rgba(37,99,235,.15);} 
  #applyFilter{
    background:var(--brand);color:#fff;padding:14px 20px;font-size:1rem;border-radius:10px;width:100%;
    align-self:end;border:none;cursor:pointer;font-weight:800;
  }
  #applyFilter:hover{background:var(--brand-dark);}
  #clearFilter{background:#e5e7eb;color:#111;padding:14px 20px;font-size:1rem;border:none;border-radius:10px;font-weight:800;}
  #clearFilter:hover{background:#d1d5db;}

  main{max-width:1100px;margin:10px auto;padding:5px;}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:10px;}
  #resultInfo{max-width:1100px;margin:4px auto 10px auto;padding:0 6px;color:#334155;font-weight:800;}

  /* ===== CARDS ===== */
  .card{background:#fff;border-radius:12px;box-shadow:0 3px 8px rgba(0,0,0,.1);cursor:pointer;transition:transform .15s,box-shadow .15s;overflow:hidden;display:flex;align-items:center;gap:12px;padding:10px;}
  .card:hover{transform:scale(1.01);box-shadow:0 6px 12px rgba(0,0,0,.15);} 
  .card-thumb{width:80px;height:80px;object-fit:cover;border-radius:10px;background:#eee;flex:0 0 auto;}
  .card-content{padding:4px 2px;flex:1;}
  .status{font-weight:700;margin-top:4px;padding:2px 10px;border-radius:999px;display:inline-block;color:#fff;}
  .contract-id{font-size:1.2rem;font-weight:900;color:#8b0000;letter-spacing:.2px;}
  .engineer-name{color:var(--brand);font-weight:700;}
  mark{background:#fef08a;padding:0 .15em;border-radius:.2em;}

  /* ===== MODAL ===== */
  #modalBg{display:none;position:fixed;inset:0;background:rgba(0,0,0,.4);justify-content:center;align-items:center;z-index:200;}
  #modalBg.show{display:flex;}
  #modalBox{background:#fff;border-radius:16px;padding:0;max-width:90%;max-height:90%;overflow-y:auto;display:flex;flex-direction:column;gap:0;}
  .modal-top{
    position:sticky;top:0;z-index:5;display:flex;align-items:center;justify-content:space-between;gap:8px;
    background:#f97316;color:#fff;padding:10px 14px;border-bottom:1px solid rgba(0,0,0,.08);box-shadow:0 2px 4px rgba(0,0,0,.08);
  }
  .modal-top-left{display:flex;align-items:center;gap:10px;}
  .modal-top-logo{width:28px;height:28px;border-radius:6px;object-fit:cover;}
  .modal-top-cid{font-weight:900;color:#fff;}
  .modal-close-btn{background:#fff;border:none;color:#f97316;font-weight:900;padding:6px 12px;border-radius:8px;cursor:pointer;line-height:1;}
  .modal-close-btn:hover{background:#ffe8d7;}

  #modalContent{display:flex;flex-direction:column;gap:6px;padding:14px;}
  #modalButtons{padding:0 14px 14px;}
  #modalImages{padding:0 14px 12px 14px;}

  .detail-row{display:flex;justify-content:space-between;flex-wrap:wrap;padding:6px 0;border-bottom:1px solid #eee;}
  .detail-label{font-size:.85rem;color:#475569;font-weight:700;}
  .detail-value{font-weight:800;color:#111;margin-left:8px;padding:2px 10px;border-radius:999px;background:#f3f4f6;}
  .detail-value.status-badge{color:#fff;background:var(--brand);}

  .detail-row.compact{display:flex;flex-direction:row;align-items:center;gap:8px;padding:4px 6px;}
  .detail-row.compact .detail-label{min-width:48px;text-align:center;background:#e2e8f0;border-radius:999px;padding:2px 8px;margin-right:0;font-weight:900;}
  .detail-row.compact .detail-value{background:transparent;padding:0;margin-left:0;font-weight:800;line-height:1.2;}
  .detail-row.emph-orange{background:#ffedd5;border-radius:10px;padding:8px;border-bottom:none;}
  .detail-row.emph-orange .detail-label{color:#7c2d12;}
  .detail-row.emph-orange .detail-value{background:transparent;}

  .detail-value.project-engineer{background:#bfdbfe;color:#1e3a8a;}
  .detail-value.project-inspector{background:#c7d2fe;color:#3730a3;}
  .detail-value.resident-engineer{background:#bbf7d0;color:#166534;}
  .detail-value.quantity-engineer{background:#fbcfe8;color:#831843;}
  .detail-value.materials-engineer{background:#fed7aa;color:#78350f;}

  /* pair grid (contractor section) */
  .pair-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px;}
  .pair-box{display:flex;flex-direction:column;justify-content:center;align-items:flex-start;background:#e0f2fe;border:1px solid #bfdbfe;border-radius:10px;padding:10px;min-height:40px;}
  .pair-label{font-size:.75rem;color:#475569;font-weight:700;margin-bottom:4px;}
  .pair-value{font-weight:900;color:#0f172a;}
  .pair-value.neg{color:#dc2626;}
  .pair-box.span-2{grid-column:1/-1;}

  .progress-wrap{margin-top:12px;}
  .progress-label{font-weight:800;color:#0f172a;margin-bottom:6px;font-size:1.05rem;text-align:center;}
  .progress-bar{width:100%;background:#e5e7eb;border-radius:12px;height:28px;overflow:hidden;position:relative;}
  .progress-fill{height:100%;border-radius:12px;text-align:center;line-height:28px;font-weight:800;color:#fff;font-size:1rem;width:0%;transition:width 900ms ease-out;white-space:nowrap;padding:0 8px;}

  .mini-bars{display:flex;flex-direction:column;gap:6px;margin-top:10px;}
  .mini-row{display:flex;align-items:center;gap:10px;}
  .mini-label{width:82px;text-align:left;font-weight:900;color:#0f172a;letter-spacing:.2px;}
  .mini-bar{flex:1;height:18px;background:#e5e7eb;border-radius:999px;overflow:hidden;}
  .mini-fill{height:100%;width:0%;display:flex;align-items:center;justify-content:center;font-size:.8rem;font-weight:800;color:#fff;transition:width 650ms ease-out;white-space:nowrap;padding:0 6px;}

  #modalButtons button{width:100%;padding:14px;margin:4px 0;border-radius:8px;font-size:1rem;border:none;cursor:pointer;font-weight:700;}
  #uploadBtn{background:#007bff;color:#fff;} 
  #uploadBtn:hover{background:#0069d9;}
  #viewPictureBtn{background:#16a34a;color:#fff;} 
  #viewPictureBtn:hover{background:#15803d;}

  .center-overlay{position:fixed;inset:0;background:rgba(15,23,42,.10);display:none;align-items:center;justify-content:center;z-index:150;}
  .center-overlay.show{display:flex;}
  .center-box{position:relative;width:160px;height:160px;background:transparent;border-radius:16px;display:flex;align-items:center;justify-content:center;padding:18px;}
  .progress-svg{width:120px;height:120px;transform:rotate(-90deg);} 
  .progress-bg{stroke:#e5e7eb;stroke-width:10;fill:none;}
  .progress-circle{stroke:var(--brand);stroke-width:10;fill:none;stroke-linecap:round;transition:stroke-dashoffset .06s linear;}
  .center-label{position:absolute;font-weight:900;color:#0f172a;font-size:1.2rem;}

  .hidden{display:none!important;}

  /* ===== GALLERY ===== */
  .gallery-overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);backdrop-filter:blur(2px);display:none;align-items:center;justify-content:center;z-index:300;}
  .gallery-overlay.show{display:flex;}
  .gallery-box{background:#0b1220;color:#e5e7eb;width:min(100svw,1100px);height:min(100svh,92svh);border-radius:14px;overflow:hidden;display:flex;flex-direction:column;box-shadow:0 16px 48px rgba(0,0,0,.45);}
  .gallery-top{display:flex;align-items:center;gap:10px;justify-content:space-between;padding:10px 14px;background:linear-gradient(135deg,var(--brand),var(--brand-dark));border-bottom:3px solid #1e3a8a;}
  .gallery-title{font-weight:900;letter-spacing:.4px;}
  .gallery-actions{display:flex;align-items:center;gap:8px;}
  .gallery-btn{background:#fff;color:#1e40af;border:none;border-radius:8px;padding:6px 12px;font-weight:900;cursor:pointer;}
  .gallery-btn:hover{background:#e2e8f0;}
  .gallery-main{position:relative;flex:1;background:#0f172a;display:flex;align-items:center;justify-content:center;overflow:hidden;}
  .gallery-img{max-width:100%;max-height:100%;object-fit:contain;display:block;}
  .nav-btn{position:absolute;top:50%;transform:translateY(-50%);border:none;background:rgba(0,0,0,.35);color:#fff;border-radius:999px;width:44px;height:44px;cursor:pointer;font-size:0;display:flex;align-items:center;justify-content:center;}
  .nav-btn:hover{background:rgba(0,0,0,.55);} 
  .nav-prev{left:12px;}
  .nav-next{right:12px;}
  .nav-btn svg{width:24px;height:24px;}
  .gallery-bottom{padding:10px;background:#0b1220;border-top:1px solid #1f2a44;display:flex;flex-direction:column;gap:8px;}
  .bottom-row{display:flex;align-items:center;gap:10px;}
  .gallery-counter{margin-right:auto;color:#cbd5e1;font-weight:800;}
  .thumb-strip{display:flex;gap:8px;overflow:auto;scrollbar-width:thin;padding-bottom:2px;}
  .thumb{width:80px;height:60px;object-fit:cover;border-radius:8px;border:2px solid transparent;opacity:.8;cursor:pointer;background:#111827;}
  .thumb.active{border-color:#86efac;opacity:1;}

  /* ===== PRESENTOR MODE (kept) ===== */
  .present-overlay{position:fixed;inset:0;background:#070b16;display:none;align-items:center;justify-content:center;z-index:5000;}
  .present-overlay.show{display:flex;}
  .present-box{width:min(100svw,1280px);height:min(100svh,96svh);background:linear-gradient(180deg,#0b1220 0%,#0b1220 55%,#0a0f1c 100%);border:1px solid #1f2a44;border-radius:18px;overflow:hidden;box-shadow:0 30px 100px rgba(0,0,0,.6);display:grid;grid-template-rows:auto 1fr auto;}
  .present-top{display:flex;align-items:center;justify-content:space-between;padding:16px 20px;background:linear-gradient(135deg,var(--brand),var(--brand-dark));border-bottom:4px solid #1e3a8a;}
  .present-cid{font-size:2rem;font-weight:900;color:#fff}
  .present-actions{display:flex;gap:10px}
  .present-btn{background:#fff;color:#1e40af;border:none;border-radius:10px;padding:10px 14px;font-weight:900;cursor:pointer}
  .present-content{display:grid;grid-template-columns:1.15fr .85fr;gap:16px;padding:16px;overflow:hidden}
  @media(max-width:980px){.present-content{grid-template-columns:1fr}}

  /* ===== MOBILE ===== */
  @media (max-width: 768px){
    /* hide header on mobile */
    header{display:none;}

    .search-top{
      flex-wrap:wrap;
      padding:0 0;
      max-width:100vw;
    }
    .search-toggle{
      width:100%;
      margin:0 0 6px 0;
    }
    .search-box-wrap{
      width:100%;
    }
    #quickSearch{
      width:100%;
      border-radius:12px;
    }
    #filters{
      max-width:100vw;
    }
  }

  /* hide header when installed as PWA/app */
  @media (display-mode: standalone){
    header{display:none;}
  }

</style>
</head>

<body>
<header>
  <div class="header-container">
    <div class="brand">
      <img src="https://drive.google.com/thumbnail?id=1VanVX82ANGfKA8jcGZL8cVDQh4EuN8-r&sz=s800" alt="PCMA Logo" class="header-logo" decoding="async"/>
      <h2 class="header-title">PCMA Mobile V3.1</h2>
    </div>
  </div>
</header>

<!-- QUICK SEARCH -->
<div class="search-top">
  <button id="openFilters" class="search-toggle">Filters</button>
  <div class="search-box-wrap">
    <!-- EMPTY placeholder as you wanted -->
    <input type="text" id="quickSearch" placeholder="" autocomplete="off" />
    <div class="search-hint">Type to search CID / Project / Location / All engineers / Contractor / Status / Year</div>
  </div>
</div>

<main>
  <!-- ADVANCED FILTERS -->
  <div id="filters" class="filters-hidden">
    <label>YEAR <select id="filterYear"><option value="">All</option></select></label>
    <label>PROJECT ENGINEER <select id="filterEngineer"><option value="">All</option></select></label>
    <label>CONTRACTOR <select id="filterContractor"><option value="">All</option></select></label>
    <label>STATUS <select id="filterStatus"><option value="">All</option></select></label>
    <button id="applyFilter">Apply</button>
    <button id="clearFilter" type="button" title="Reset filters">Clear</button>
  </div>

  <div id="resultInfo" class="hidden"></div>
  <div id="grid" class="grid hidden"></div>
  <div id="loader" class="hidden"></div>
</main>

<!-- MODAL -->
<div id="modalBg" role="dialog" aria-modal="true" aria-labelledby="modalCID">
  <div id="modalBox">
    <div class="modal-top">
      <div class="modal-top-left">
        <img class="modal-top-logo" src="https://i.ibb.co/RRJpHk2/PCMA-logo-1.png" alt="PCMA" />
        <div id="modalCID" class="modal-top-cid">—</div>
      </div>
      <div class="modal-nav" id="modalNav" style="display:flex;gap:8px;margin-right:auto;margin-left:10px;align-items:center;">
        <button id="modalPrev" class="modal-close-btn" style="color:#f97316;background:#fff;">Prev</button>
        <button id="modalNext" class="modal-close-btn" style="color:#f97316;background:#fff;">Next</button>
        <span id="modalNavPos" style="font-weight:800;opacity:.9;margin-left:6px">—</span>
      </div>
      <button id="closeModalTop" class="modal-close-btn" aria-label="Close modal">Close</button>
    </div>
    <div id="modalBody">
      <div id="modalContent"></div>
      <div id="modalButtons"></div>
      <div id="modalImages"></div>
    </div>
  </div>
</div>

<!-- Centered loading overlay -->
<div id="centerOverlay" class="center-overlay" aria-live="polite">
  <div class="center-box">
    <svg class="progress-svg" viewBox="0 0 120 120" aria-hidden="true">
      <circle class="progress-bg" cx="60" cy="60" r="54"></circle>
      <circle id="progressCircle" class="progress-circle" cx="60" cy="60" r="54"></circle>
    </svg>
    <div id="centerLabel" class="center-label">0%</div>
  </div>
</div>

<!-- GALLERY -->
<div id="galleryOverlay" class="gallery-overlay" role="dialog" aria-modal="true" aria-labelledby="galleryCID">
  <div class="gallery-box" id="galleryBox">
    <div class="gallery-top">
      <div class="gallery-title" id="galleryCID">—</div>
      <div class="gallery-actions">
        <a id="galleryOpen" class="gallery-btn" href="#" target="_blank" rel="noopener">Open</a>
        <button id="galleryClose" class="gallery-btn" aria-label="Close gallery">Close</button>
      </div>
    </div>
    <div class="gallery-main" id="galleryMain">
      <button class="nav-btn nav-prev" id="galleryPrev" aria-label="Previous image">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg>
      </button>
      <img id="galleryImg" class="gallery-img" alt="Gallery image"/>
      <button class="nav-btn nav-next" id="galleryNext" aria-label="Next image">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg>
      </button>
    </div>
    <div class="gallery-bottom">
      <div class="bottom-row">
        <div class="gallery-counter" id="galleryCounter">0 / 0</div>
      </div>
      <div class="thumb-strip" id="galleryThumbs"></div>
    </div>
  </div>
</div>

<script>
/* ===== CONFIG ===== */
const SHEET_ID="1LSYLZ7tfSeVupQMPsCOHG4SlnzPQqOAIe03QI1qRMr8";
const RANGE="APP";
const API_KEY="AIzaSyCz6fNJr3ecn-M2HActqM1aCXbxqRLj2e8";
const LOGO_FALLBACK="https://i.ibb.co/RRJpHk2/PCMA-logo-1.png";

/* ===== ELEMENTS ===== */
const grid=document.getElementById('grid');
const resultInfo=document.getElementById('resultInfo');
const filtersBox=document.getElementById('filters');
const openFiltersBtn=document.getElementById('openFilters');
const filterYear=document.getElementById('filterYear');
const filterStatus=document.getElementById('filterStatus');
const filterContractor=document.getElementById('filterContractor');
const filterEngineer=document.getElementById('filterEngineer');
const applyFilterBtn=document.getElementById('applyFilter');
const clearFilterBtn=document.getElementById('clearFilter');
const quickSearch=document.getElementById('quickSearch');

const modalBg=document.getElementById('modalBg');
const modalContent=document.getElementById('modalContent');
const modalButtons=document.getElementById('modalButtons');
const modalImages=document.getElementById('modalImages');
const closeModalTop=document.getElementById('closeModalTop');
const modalCID=document.getElementById('modalCID');

const galleryOverlay = document.getElementById('galleryOverlay');
const galleryCID = document.getElementById('galleryCID');
const galleryImg = document.getElementById('galleryImg');
const galleryPrev = document.getElementById('galleryPrev');
const galleryNext = document.getElementById('galleryNext');
const galleryCounter = document.getElementById('galleryCounter');
const galleryThumbs = document.getElementById('galleryThumbs');
const galleryOpenLink = document.getElementById('galleryOpen');
const galleryCloseBtn = document.getElementById('galleryClose');
const galleryMain = document.getElementById('galleryMain');

let headers=[],records=[]; 
let lastRenderedRows=[];
let galleryItems=[]; 
let galleryIndex=0; 
let activeCID='—';

/* ===== helpers ===== */
function esc(s){
  return String(s).replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]));
}
function highlightText(text,query){
  const t=String(text||''); if(!query) return esc(t);
  const q=query.toLowerCase(); const i=t.toLowerCase().indexOf(q);
  if(i===-1) return esc(t);
  return esc(t.slice(0,i))+"<mark>"+esc(t.slice(i,i+q.length))+"</mark>"+esc(t.slice(i+q.length));
}
function toPct(val,fallback=0){
  if(val==null) return fallback;
  const m=String(val).replace(',', '.').match(/-?\d+(\.\d+)?/);
  return m?parseFloat(m[0]):fallback;
}
function animateMiniBar(fillEl,value,duration=800,formatFn=null){
  const sign=value<0?-1:1; const endAbs=Math.min(Math.abs(value),100);
  const startTime=performance.now();
  function step(now){
    const t=Math.min(1,(now-startTime)/duration);
    const cur=endAbs*t; fillEl.style.width=cur+'%';
    const display=sign*cur; fillEl.textContent=formatFn?formatFn(display):`${display.toFixed(2)}%`;
    if(t<1) requestAnimationFrame(step);
    else { fillEl.style.width=endAbs+'%'; fillEl.textContent=formatFn?formatFn(sign*endAbs):`${(sign*endAbs).toFixed(2)}%`; }
  }
  requestAnimationFrame(step);
}
function colorForSlippage(num){
  if(num>0) return {bg:'#10b981',text:'#fff',sad:false};
  if(num<=0 && num>-5) return {bg:'#fecaca',text:'#7f1d1d',sad:false};
  if(num<=-5 && num>-10) return {bg:'#f87171',text:'#fff',sad:true};
  if(num<=-10) return {bg:'#dc2626',text:'#fff',sad:true};
  return {bg:'#6b7280',text:'#fff',sad:false};
}
function parseMoney(v){ if(v==null) return null; const s=String(v).replace(/[^0-9.\-]/g,''); const n=parseFloat(s); return Number.isFinite(n)?n:null; }
function fmtPHP(n){ try{ return '₱ ' + Number(n).toLocaleString('en-PH',{minimumFractionDigits:2, maximumFractionDigits:2}); }catch{ return '₱ ' + n; } }
function findCol(){ const keys=[...arguments].map(k=>String(k).toLowerCase()); return headers.findIndex(h=> keys.some(k=> h.includes(k))); }
function isValidUrl(u){ try{ const x=new URL(u); return x.protocol==='http:'||x.protocol==='https:'; }catch{return false;} }
function nonEmptyRows(arr){ return (arr||[]).filter(r => Array.isArray(r) && r.join('').trim() !== ''); }

/* ===== data load ===== */
async function loadData(){
  const url=`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${RANGE}?key=${API_KEY}`;
  try{
    const res=await fetch(url);
    const data=await res.json();
    if(!data.values || !data.values.length) throw new Error('No data returned');

    const keyHints = ['contract id','project name','location','status'];
    let headerRowIndex = 0;
    for(let i=0;i<data.values.length;i++){
      const row = (data.values[i]||[]).map(c=>String(c||'').trim().toLowerCase());
      const hit = keyHints.some(h => row.some(cell => cell.includes(h)));
      if(hit){ headerRowIndex = i; break; }
    }

    headers = (data.values[headerRowIndex]||[]).map(h=>(h||'').trim().toLowerCase().replace(/[:]+/g,''));
    records = data.values.slice(headerRowIndex+1);

    populateFilterOptions();

    // show all right away
    const clean = nonEmptyRows(records);
    renderGrid(clean);
    resultInfo.textContent = `${clean.length} projects`;
    resultInfo.classList.remove('hidden');
  }catch(e){
    console.error(e);
    grid.classList.remove('hidden');
    grid.innerHTML = `<div style="grid-column:1/-1;text-align:center;padding:20px;color:#b91c1c;">Failed to load data.</div>`;
  }
}

/* ===== filters ===== */
function populateFilterOptions(){
  const years=new Set(),contractors=new Set(),engineers=new Set(),statuses=new Set();
  const colYear=headers.findIndex(h=>h.includes('year'));
  const colContractor=headers.findIndex(h=>h.includes('contractor'));
  const colEngineer=headers.findIndex(h=>h.includes('project engineer'));
  const colStatus=headers.findIndex(h=>h.includes('status'));
  records.forEach(r=>{
    if(colYear>=0&&r[colYear])years.add(r[colYear]);
    if(colContractor>=0&&r[colContractor])contractors.add(r[colContractor]);
    if(colEngineer>=0&&r[colEngineer])engineers.add(r[colEngineer]);
    if(colStatus>=0&&r[colStatus])statuses.add(String(r[colStatus]).trim());
  });
  filterYear.innerHTML='<option value="">All</option>'+[...years].sort().map(y=>`<option value="${y}">${y}</option>`).join('');
  filterContractor.innerHTML='<option value="">All</option>'+[...contractors].sort().map(c=>`<option value="${c}">${c}</option>`).join('');
  filterEngineer.innerHTML='<option value="">All</option>'+[...engineers].sort().map(e=>`<option value="${e}">${e}</option>`).join('');
  filterStatus.innerHTML='<option value="">All</option>'+[...statuses].sort().map(s=>`<option value="${s}">${s}</option>`).join('');
}

function toggleFilters(force){
  const isHidden = filtersBox.classList.contains('filters-hidden');
  const shouldHide = (force === undefined) ? !isHidden : force;
  if(shouldHide){
    filtersBox.classList.add('filters-hidden');
  }else{
    filtersBox.classList.remove('filters-hidden');
  }
}
openFiltersBtn.addEventListener('click',()=>toggleFilters());

/* ===== quick search ===== */
function runQuickSearch(){
  const q = (quickSearch.value||'').trim().toLowerCase();
  const base = nonEmptyRows(records);

  const y=(filterYear.value||'').toLowerCase();
  const s=(filterStatus.value||'').toLowerCase();
  const c=(filterContractor.value||'').toLowerCase();
  const e=(filterEngineer.value||'').toLowerCase();

  const colCID=headers.findIndex(h=>h.includes('contract id'));
  const colPN=headers.findIndex(h=>h.includes('project name'));
  const colLoc=headers.findIndex(h=>h.includes('location'));
  const colPE=headers.findIndex(h=>h.includes('project engineer'));
  const colPI=headers.findIndex(h=>h.includes('project inspector'));
  const colRE=headers.findIndex(h=>h.includes('resident engineer'));
  const colQE=headers.findIndex(h=>h.includes('quantity engineer'));
  const colME=headers.findIndex(h=>h.includes('materials engineer'));
  const colCont=headers.findIndex(h=>h.includes('contractor'));
  const colStat=headers.findIndex(h=>h.includes('status'));
  const colYear=headers.findIndex(h=>h.includes('year'));

  const filtered = base.filter(r=>{
    const byYear = (!y || (colYear>-1 && String(r[colYear]||'').toLowerCase()===y));
    const byStat = (!s || (colStat>-1 && String(r[colStat]||'').toLowerCase()===s));
    const byCont = (!c || (colCont>-1 && String(r[colCont]||'').toLowerCase()===c));
    const byEng  = (!e || (colPE>-1 && String(r[colPE]||'').toLowerCase()===e));
    if(!(byYear && byStat && byCont && byEng)) return false;

    if(!q) return true;
    const fields = [
      colCID>-1 ? r[colCID] : '',
      colPN>-1 ? r[colPN] : '',
      colLoc>-1 ? r[colLoc] : '',
      colPE>-1 ? r[colPE] : '',
      colPI>-1 ? r[colPI] : '',
      colRE>-1 ? r[colRE] : '',
      colQE>-1 ? r[colQE] : '',
      colME>-1 ? r[colME] : '',
      colCont>-1 ? r[colCont] : '',
      colStat>-1 ? r[colStat] : '',
      colYear>-1 ? r[colYear] : ''
    ];
    return fields.some(v => String(v||'').toLowerCase().includes(q));
  });

  renderGrid(filtered);
  resultInfo.textContent = `${filtered.length} project${filtered.length!==1?'s':''}`;
  resultInfo.classList.remove('hidden');
}
quickSearch.addEventListener('input', runQuickSearch);
applyFilterBtn.addEventListener('click', ()=>{ runQuickSearch(); toggleFilters(true); });
clearFilterBtn.addEventListener('click', ()=>{
  filterYear.value='';
  filterStatus.value='';
  filterContractor.value='';
  filterEngineer.value='';
  runQuickSearch();
});

/* ===== GRID ===== */
function renderGrid(rows){
  lastRenderedRows = rows.slice();
  grid.innerHTML="";
  const colContractID=headers.findIndex(h=>h.includes('contract id'));
  const colProjectName=headers.findIndex(h=>h.includes('project name'));
  const colStatus=headers.findIndex(h=>h.includes('status'));
  const colEngineer=headers.findIndex(h=>h.includes('project engineer'));
  const colLocation=headers.findIndex(h=>h.includes('location'));
  const colImage1=headers.findIndex(h=>h.includes('image 1'));

  if(rows.length===0){
    grid.classList.remove('hidden');
    grid.innerHTML=`<div style="grid-column:1/-1;text-align:center;padding:20px;color:#777;">No data found.</div>`;
    return;
  }

  grid.classList.remove('hidden');
  rows.forEach((r,idx)=>{
    if(!r || !r.join('').trim()) return;

    const card=document.createElement('div'); 
    card.className='card';
    card.dataset.rowIndex = String(idx);

    const img=document.createElement('img');
    const link=(colImage1>=0 && r[colImage1])?String(r[colImage1]).trim():'';
    img.src=link||LOGO_FALLBACK; img.className='card-thumb'; img.loading='lazy'; img.decoding='async';
    img.onerror=()=>{img.src=LOGO_FALLBACK;};
    card.appendChild(img);

    const content=document.createElement('div'); content.className='card-content';

    const headerRow=document.createElement('div');
    headerRow.style.display='flex'; headerRow.style.justifyContent='space-between'; headerRow.style.alignItems='baseline';
    const q=(quickSearch.value||'').trim().toLowerCase();
    const cidText=(colContractID>=0 && r[colContractID])?r[colContractID]:'';
    const engText=(colEngineer>=0 && r[colEngineer])?r[colEngineer]:'';
    headerRow.innerHTML = `<span class="contract-id">${highlightText(cidText,q)}</span><span class="engineer-name">${esc(engText)}</span>`;
    content.appendChild(headerRow);

    const nameDiv=document.createElement('div');
    nameDiv.style.marginTop='4px';
    const projText=(colProjectName>=0 && r[colProjectName])?r[colProjectName]:'';
    nameDiv.innerHTML=`<b>Project:</b> ${highlightText(projText,q)}`;
    content.appendChild(nameDiv);

    if(colLocation>=0 && r[colLocation]){
      const locDiv=document.createElement('div');
      locDiv.style.marginTop='2px';
      locDiv.innerHTML=`<b>Location:</b> ${highlightText(r[colLocation],q)}`;
      content.appendChild(locDiv);
    }

    const statusDiv=document.createElement('div');
    const statusText=((colStatus>=0 && r[colStatus])?String(r[colStatus]):'').trim();
    const t=statusText.toLowerCase(); let bg='#777';
    if(t==='completed (pcma)'||t==='pcma') bg='#2563eb';
    else if(t==='completed') bg='#16a34a';
    else if(t==='on-going') bg='#f97316';
    else if(t==='100%') bg='#14b8a6';
    statusDiv.innerHTML=`<span class="status" style="background:${bg}">${esc(statusText)}</span>`;
    content.appendChild(statusDiv);

    card.appendChild(content);
    card.onclick=()=>showDetail(r);
    grid.appendChild(card);
  });
}

/* ===== image helpers ===== */
function collectImageUrls(row){
  const list = [];
  for (let i = 1; i <= 60; i++){
    const ci = headers.findIndex(h => {
      const hh = String(h || '').toLowerCase();
      return hh.includes(`image ${i}`) || hh === `image${i}`;
    });
    if (ci >= 0) {
      const url = String(row[ci] || '').trim();
      if (url) list.push({ label: `Image ${i}`, url });
    }
  }
  return list;
}

function showGalleryIndex(idx){
  if(!galleryItems.length) return;
  galleryIndex = (idx+galleryItems.length)%galleryItems.length;
  const item = galleryItems[galleryIndex];
  galleryImg.style.opacity = '0';
  const img = new Image();
  img.onload = ()=>{
    galleryImg.src = item.url;
    galleryImg.alt = item.label + ' - ' + activeCID;
    galleryImg.style.opacity = '1';
  };
  img.onerror = ()=>{ galleryImg.src = LOGO_FALLBACK; galleryImg.style.opacity = '1'; };
  img.src = item.url;
  galleryOpenLink.href = item.url;
  galleryCounter.textContent = `${galleryIndex+1} / ${galleryItems.length}`;
  [...galleryThumbs.children].forEach((el,i)=>el.classList.toggle('active', i===galleryIndex));
  const activeThumb = galleryThumbs.children[galleryIndex];
  if(activeThumb){ activeThumb.scrollIntoView({inline:'center',behavior:'smooth',block:'nearest'}); }
}

function openFloatingGallery(row){
  const imgs = collectImageUrls(row);
  if(imgs.length===0){
    alert('No images available for this record.');
    return;
  }
  const cidIdx=headers.findIndex(h=>h.includes('contract id'));
  activeCID=(cidIdx>=0?row[cidIdx]:'')||'—';
  galleryItems = imgs;
  galleryIndex = 0;
  galleryThumbs.innerHTML = '';
  imgs.forEach((it, i)=>{
    const th = document.createElement('img');
    th.className='thumb'; th.src=it.url; th.alt=it.label; th.loading='lazy';
    th.addEventListener('click', (ev)=>{ ev.stopPropagation(); showGalleryIndex(i); });
    galleryThumbs.appendChild(th);
  });
  galleryCID.textContent = activeCID;
  showGalleryIndex(0);
  galleryOverlay.classList.add('show');
  document.body.classList.add('no-scroll');
}
function closeFloatingGallery(){
  galleryOverlay.classList.remove('show');
  document.body.classList.remove('no-scroll');
}
galleryPrev.addEventListener('click', (e)=>{ e.stopPropagation(); showGalleryIndex(galleryIndex-1); });
galleryNext.addEventListener('click', (e)=>{ e.stopPropagation(); showGalleryIndex(galleryIndex+1); });
galleryCloseBtn.addEventListener('click', (e)=>{ e.stopPropagation(); closeFloatingGallery(); });
galleryOverlay.addEventListener('click', (e)=>{
  if(e.target === galleryOverlay) closeFloatingGallery();
});
window.addEventListener('keydown', (e)=>{
  if(!galleryOverlay.classList.contains('show')) return;
  if(e.key==='Escape') closeFloatingGallery();
  else if(e.key==='ArrowRight') showGalleryIndex(galleryIndex+1);
  else if(e.key==='ArrowLeft') showGalleryIndex(galleryIndex-1);
});

/* ===== MODAL ===== */
function showDetail(row){
  document.body.classList.add('no-scroll');
  modalBg.classList.add('show');
  try{
    modalContent.innerHTML=''; modalButtons.innerHTML=''; modalImages.innerHTML='';
    const cidIdx=headers.findIndex(h=>h.includes('contract id'));
    modalCID.textContent=(cidIdx>=0?row[cidIdx]:'')||'—';

    const colUpload=headers.findIndex(h=>h.includes('upload pictures'));
    const colStatus=headers.findIndex(h=>h.includes('status'));
    const colSched=headers.findIndex(h=>h.includes('sched'));
    const colActual=headers.findIndex(h=>h.includes('actual'));
    const colSlip=headers.findIndex(h=>h.includes('slip'));
    const colDelay=headers.findIndex(h=>h.includes('delay'));
    let colProg=headers.findIndex(h=>h.includes('progress')); if(colProg<0) colProg=18;

    function statusColor(v){
      const t=(v||'').toLowerCase();
      if(t==='completed (pcma)'||t==='pcma') return '#2563eb';
      if(t==='completed') return '#16a34a';
      if(t==='on-going') return '#f97316';
      if(t==='100%') return '#14b8a6';
      return '#6b7280';
    }

    headers.forEach((h,i)=>{
      const raw=(h||'').trim(); 
      const L=raw.replace(/[:]/g,'').toUpperCase(); 
      const V=row[i]||''; 
      if(!V) return;
      if(L.startsWith('IMAGE')||L.includes('FOLDER')||L.includes('UPLOAD PICTURES')) return;
      const HIDE_KEYS=['SCHEDULE','ACTUAL','SLIPPAGE','DELAY','PROGRESS','YEAR','CONTRACT ID','ABC','CONTRACT AMOUNT','VARIANCE','CALENDAR DAYS','(CD)','CD','NOTICE TO PROCEED','NTP','EXPIRY DATE','ORIGINAL EXPIRY DATE','REVISED EXPIRY DATE','REV. EXPIRY DATE','REV EXPIRY DATE','DATE OF COMPLETION','COMPLETION DATE','CERTIFICATE OF COMPLETION','CERTIFICATE OF ACCEPTANCE','COC','COA'];
      if(HIDE_KEYS.some(k=>L.includes(k))) return;

      const d=document.createElement('div'); d.className='detail-row';
      const SHORT_MAP={'PROJECT ENGINEER':'PE','PROJECT INSPECTOR':'PI','RESIDENT ENGINEER':'RE','QUANTITY ENGINEER':'QE','MATERIALS ENGINEER':'ME'};
      let displayLabel=L;
      if(SHORT_MAP[L]){ displayLabel=SHORT_MAP[L]; d.classList.add('compact'); }
      const CENTER_SET=new Set(['PROJECT NAME','LOCATION','CONTRACTOR','REMARKS','LAST BILLING']);
      if(CENTER_SET.has(L)) d.classList.add('center-row');

      let chipClass='';
      if(L.includes('PROJECT ENGINEER'))chipClass='project-engineer';
      else if(L.includes('PROJECT INSPECTOR'))chipClass='project-inspector';
      else if(L.includes('RESIDENT ENGINEER'))chipClass='resident-engineer';
      else if(L.includes('QUANTITY ENGINEER'))chipClass='quantity-engineer';
      else if(L.includes('MATERIALS ENGINEER'))chipClass='materials-engineer';

      if(L==='STATUS'){
        const sv=(colStatus>=0?row[colStatus]:V)||'';
        d.innerHTML=`<span class="detail-label">${L}:</span><span class="detail-value status-badge" style="background:${statusColor(sv)}">${esc(sv)}</span>`;
      }else{
        d.innerHTML=`<span class="detail-label">${displayLabel}:</span><span class="detail-value ${chipClass}">${esc(V)}</span>`;
      }
      modalContent.appendChild(d);

      /* contractor block */
      if(L==='CONTRACTOR'){
        const abcIdx = findCol('abc','approved budget for the contract');
        const amtIdx = findCol('contract amount','amount');
        const revAmtIdx = findCol('revised contract amount','rev. contract amount','rev contract amount');
        const cdIdx = findCol('cd','calendar days');
        const revCdIdx = findCol('rev cd','revised cd','revised calendar days');
        const ntpIdx = findCol('notice to proceed','ntp');
        const expIdx = findCol('expiry date','original expiry date');          
        const revExpIdx = findCol('rev. expiry date','revised expiry date','rev expiry date');  
        const docIdx = findCol('date of completion','completion date','doc');
        const cocIdx = findCol('certificate of completion','cert of completion','coc');
        const coaIdx = findCol('certificate of acceptance','cert of acceptance','coa');

        const abcV = abcIdx>-1?row[abcIdx]:'';
        const amtV = amtIdx>-1?row[amtIdx]:'';
        const revAmtV = revAmtIdx>-1?row[revAmtIdx]:'';
        const cdV = cdIdx>-1?row[cdIdx]:'';
        const revCdV = revCdIdx>-1?row[revCdIdx]:'';
        const ntpV = ntpIdx>-1?row[ntpIdx]:'';
        const expV = expIdx>-1?row[expIdx]:'';
        const revExpV = revExpIdx>-1?row[revExpIdx]:'';
        const docV = docIdx>-1?row[docIdx]:'';
        const cocV = cocIdx>-1?row[cocIdx]:'';
        const coaV = coaIdx>-1?row[coaIdx]:'';

        const abcText = (parseMoney(abcV)!=null)? fmtPHP(parseMoney(abcV)) : (abcV||'—');
        const amtText = (parseMoney(amtV)!=null)? fmtPHP(parseMoney(amtV)) : (amtV||'—');
        const revAmtText = (parseMoney(revAmtV)!=null)? fmtPHP(parseMoney(revAmtV)) : (revAmtV||'—');
        const cdText = (parseMoney(cdV)!=null)? `${Math.round(parseMoney(cdV))} days` : (cdV||'—');
        const revCdText = (parseMoney(revCdV)!=null)? `${Math.round(parseMoney(revCdV))} days` : (revCdV||'—');
        const ntpText = ntpV||'—';
        const expText = expV||'—';
        const revExpText = revExpV||'—';
        const docText = docV||'—';
        const cocText = cocV||'—';
        const coaText = coaV||'—';

        const grid=document.createElement('div'); grid.className='pair-grid';
        function addBox(label,value,span2=false,neg=false){
          const box=document.createElement('div'); box.className='pair-box' + (span2?' span-2':'');
          const l=document.createElement('span'); l.className='pair-label'; l.textContent=label;
          const v=document.createElement('span'); v.className='pair-value'; if(neg) v.classList.add('neg'); v.textContent=value||'—';
          box.appendChild(l); box.appendChild(v); grid.appendChild(box);
        }
        addBox('ABC', abcText);
        addBox('Contract Amount', amtText);
        addBox('Rev. Contract Amount', revAmtText);
        { const __vIdx = findCol('variance'); const __vRaw = __vIdx>-1?row[__vIdx]:'—'; const __vNum = parseMoney(__vRaw); addBox('Variance', __vRaw||'—', false, (__vNum??0) < 0); }
        addBox('CD', cdText);
        addBox('Rev. CD', revCdText);
        addBox('NTP', ntpText);
        addBox('Expiry Date', expText);
        addBox('Rev. Expiry Date', revExpText);
        addBox('Date of Completion', docText);
        addBox('Certificate of Completion', cocText);
        addBox('Certificate of Acceptance', coaText);

        modalContent.appendChild(grid);
      }

      if(L==='STATUS'){
        const schedNum=toPct((colSched>=0&&row[colSched])?row[colSched]:'0%',0);
        const actualNum=toPct((colActual>=0&&row[colActual])?row[colActual]:'0%',0);
        const slipNum=toPct((colSlip>=0&&row[colSlip])?row[colSlip]:'0%',0);

        const mini=document.createElement('div'); mini.className='mini-bars';
        function makeMini(label,num,baseColor,isSlippage=false){
          const r=document.createElement('div'); r.className='mini-row';
          const lab=document.createElement('div'); lab.className='mini-label'; lab.textContent=label;
          const bar=document.createElement('div'); bar.className='mini-bar';
          const fill=document.createElement('div'); fill.className='mini-fill';
          if(isSlippage){
            const cfg=colorForSlippage(num);
            fill.style.background=cfg.bg; fill.style.color=cfg.text;
            bar.appendChild(fill); r.appendChild(lab); r.appendChild(bar); mini.appendChild(r);
            animateMiniBar(fill,num,800,(v)=>`${v.toFixed(2)}%${(cfg.sad && v<=-10)?' ☹️':''}`);
          }else{
            fill.style.background=baseColor; bar.appendChild(fill); r.appendChild(lab); r.appendChild(bar); mini.appendChild(r);
            animateMiniBar(fill,num,800,(v)=>`${v.toFixed(2)}%`);
          }
        }
        makeMini('SCHED',schedNum,'#3b82f6',false);
        makeMini('ACTUAL',actualNum,'#10b981',false);
        makeMini('SLIPPAGE',slipNum,null,true);
        modalContent.appendChild(mini);

        const progRaw=(colProg>=0&&row[colProg])?String(row[colProg]).trim():'0%';
        const delayRaw=(colDelay>=0&&row[colDelay])?String(row[colDelay]).trim():'';
        let pctNum=Math.max(0,toPct(progRaw,0));

        const wrap=document.createElement('div'); wrap.className='progress-wrap';
        const label=document.createElement('div'); label.className='progress-label'; label.textContent='Time Lapsed';
        const bar=document.createElement('div'); bar.className='progress-bar';
        const fill=document.createElement('div'); fill.className='progress-fill'; fill.textContent='0%';
        bar.appendChild(fill); wrap.appendChild(label); wrap.appendChild(bar); modalContent.appendChild(wrap);

        function colorFor(v){ if(v>100) return '#dc2626'; if(v>=100) return '#16a34a'; if(v>80) return '#f97316'; return '#60a5fa'; }
        fill.style.background=colorFor(pctNum);

        requestAnimationFrame(()=>{
          const startTime=performance.now(),duration=900,start=0,end=pctNum;
          function step(now){
            const t=Math.min(1,(now-startTime)/duration);
            const curr=start+(end-start)*t, width=Math.min(curr,100);
            fill.style.width=width+'%';
            fill.textContent=`${Math.round(curr)}%${delayRaw?' ('+esc(delayRaw)+')':''}`;
            if(t<1) requestAnimationFrame(step);
            else { fill.style.width=Math.min(end,100)+'%'; fill.style.background=colorFor(end); fill.textContent=`${Math.round(end)}%${delayRaw?' ('+esc(delayRaw)+')':''}`; }
          }
          requestAnimationFrame(step);
        });
      }
    });

    // Upload button (use earlier colUpload!)
    if(colUpload>=0){
      const link = String(row[colUpload]||'').trim();
      if(link && isValidUrl(link)){
        const b=document.createElement('button');
        b.id='uploadBtn'; b.textContent='Upload Picture';
        b.onclick=e=>{ e.stopPropagation(); window.open(link,'_blank','noopener'); };
        modalButtons.appendChild(b);
      }
    }

    // View picture (floating)
    const viewBtn=document.createElement('button');
    viewBtn.id='viewPictureBtn'; 
    viewBtn.textContent='View Picture';
    viewBtn.onclick=e=>{ e.stopPropagation(); openFloatingGallery(row); };
    modalButtons.appendChild(viewBtn);

    // Projector Mode
    const presentBtn=document.createElement('button');
    presentBtn.id='presentBtn'; presentBtn.textContent='Present (Projector Mode)';
    presentBtn.style.background='#111827'; presentBtn.style.color='#fff';
    presentBtn.style.border='1px solid #334155'; presentBtn.style.borderRadius='8px';
    presentBtn.style.padding='14px'; presentBtn.style.width='100%'; presentBtn.style.fontWeight='800'; presentBtn.style.margin='4px 0';
    presentBtn.onclick=(e)=>{ e.stopPropagation(); openPresentation(row); };
    modalButtons.appendChild(presentBtn);

    // No images message
    const hasAny = collectImageUrls(row).length > 0;
    if(!hasAny){
      const box=document.createElement('div'); 
      box.style.textAlign='center'; box.style.marginTop='12px';
      const cap=document.createElement('p'); 
      cap.textContent='No images available';
      cap.style.color='#2563eb'; cap.style.fontWeight='700'; cap.style.marginTop='8px';
      box.appendChild(cap); 
      modalImages.appendChild(box);
    }

  }catch(err){
    console.error('Modal render error:', err);
    modalContent.innerHTML = `<div style="padding:16px;color:#b91c1c;font-weight:700;">Error loading details.</div>`;
  }
}

function closeModal(){ modalBg.classList.remove('show'); document.body.classList.remove('no-scroll'); }
closeModalTop.addEventListener('click',closeModal);
modalBg.addEventListener('click',e=>{ if(e.target===modalBg) closeModal(); });
document.addEventListener('keydown',e=>{ if(e.key==='Escape' && modalBg.classList.contains('show')) closeModal(); });

/* ===== PRESENTATION (same logic) ===== */
(function(){
  if (document.getElementById('presentOverlay')) return;
  const wrap = document.createElement('div');
  wrap.id = 'presentOverlay';
  wrap.className = 'present-overlay';
  wrap.innerHTML = `
    <div class="present-box" role="dialog" aria-modal="true" aria-labelledby="presentCID">
      <div class="present-top">
        <div id="presentCID" class="present-cid">—</div>
        <div class="present-actions">
          <button id="presentPlay" class="present-btn" title="Play/Pause">Play</button>
          <button id="presentOpen" class="present-btn" title="Open Current Image">Open</button>
          <button id="presentClose" class="present-btn" title="Close">Close</button>
        </div>
      </div>
      <div class="present-content">
        <div class="present-left">
          <button class="nav present-prev" aria-label="Prev">
            <svg viewBox="0 0 24 24" width="26" height="26" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg>
          </button>
          <div id="presentSlides"></div>
          <div class="present-thumbs" id="presentThumbs"></div>
          <button class="nav present-next" aria-label="Next">
            <svg viewBox="0 0 24 24" width="26" height="26" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg>
          </button>
        </div>
        <div class="present-right">
          <div class="present-grid">
            <div class="present-cell span-2"><div class="present-title">Project Name</div><div id="presentProj" class="present-value">—</div></div>
            <div class="present-cell span-2"><div class="present-title">Contractor</div><div id="presentContractor" class="present-value">—</div></div>
            <div class="present-cell"><div class="present-title">Contract Amount</div><div id="presentAmt" class="present-value">—</div></div>
            <div class="present-cell"><div class="present-title">Rev. Contract Amount</div><div id="presentRevAmt" class="present-value">—</div></div>
            <div class="present-cell span-2">
              <div class="present-grid-3">
                <div class="present-cell-small"><div class="present-title">NTP</div><div id="presentNTP" class="present-value">—</div></div>
                <div class="present-cell-small"><div class="present-title">Expiry Date</div><div id="presentExpiry" class="present-value">—</div></div>
                <div class="present-cell-small"><div class="present-title">Rev. Expiry Date</div><div id="presentRevExpiry" class="present-value">—</div></div>
              </div>
            </div>
            <div class="present-cell span-2">
              <div class="present-title">Schedule / Actual / Slippage</div>
              <div class="mini-bars">
                <div class="mini-row"><div class="mini-label">SCHED</div><div class="mini-bar"><div id="pMiniSched" class="mini-fill" style="width:0%"></div></div></div>
                <div class="mini-row"><div class="mini-label">ACTUAL</div><div class="mini-bar"><div id="pMiniActual" class="mini-fill" style="width:0%"></div></div></div>
                <div class="mini-row"><div class="mini-label">SLIPPAGE</div><div class="mini-bar"><div id="pMiniSlip" class="mini-fill" style="width:0%"></div></div></div>
              </div>
            </div>
            <div class="present-cell span-2"><div class="present-title">Remarks</div><div id="presentRemarks" class="present-remarks">—</div></div>
            <div class="present-cell span-2"><div class="present-title">Status</div><div class="present-value"><span id="presentStatusChip" class="status-chip">—</span></div></div>
          </div>
        </div>
      </div>
      <div class="present-footer">
        <div id="presentCounter" class="present-counter">0 / 0</div>
        <div style="color:#94a3b8;font-weight:800">Press ← / → to navigate • Esc to close</div>
      </div>
    </div>
  `;
  document.body.appendChild(wrap);

  const overlay=document.getElementById('presentOverlay');
  const slides=document.getElementById('presentSlides');
  const thumbs=document.getElementById('presentThumbs');
  const counter=document.getElementById('presentCounter');
  const state={items:[],index:0,timer:null,delay:6000,row:null};

  function statusChipColor(t){const s=(t||'').toLowerCase().trim(); if(s==='completed (pcma)'||s==='pcma') return '#2563eb'; if(s==='completed') return '#16a34a'; if(s==='on-going') return '#f59e0b'; if(s==='100%') return '#14b8a6'; return '#64748b';}
  function parseMoneySafe(v){const s=String(v??'').replace(/[^0-9.\-]/g,''); const n=parseFloat(s); return Number.isFinite(n)?n:null;}
  function fmtPHPsafe(n){try{return '₱ ' + Number(n||0).toLocaleString('en-PH',{minimumFractionDigits:2,maximumFractionDigits:2});}catch{return '₱ '+(n??'—');}}
  function fmtDateSafe(x){const raw=(x||'').toString().trim(); if(!raw) return '—'; const d=new Date(raw); if(!isNaN(d)) return d.toLocaleDateString('en-US',{year:'numeric',month:'short',day:'2-digit'}); return raw;}

  function showIndex(i){
    if(!state.items.length) return;
    const N=state.items.length; state.index=(i%N+N)%N;
    [...slides.children].forEach((el,idx)=>el.classList.toggle('active',idx===state.index));
    [...thumbs.children].forEach((el,idx)=>el.classList.toggle('active',idx===state.index));
    counter.textContent=`${state.index+1} / ${N}`;
  }
  function startAuto(force){ if(force) stopAuto(); if(state.timer||!state.items.length) return; const tick=()=>{showIndex(state.index+1); state.timer=setTimeout(tick,state.delay);} ; state.timer=setTimeout(tick,state.delay); document.getElementById('presentPlay').textContent='Pause'; }
  function stopAuto(){ if(state.timer){clearTimeout(state.timer); state.timer=null;} document.getElementById('presentPlay').textContent='Play'; }
  function barsAnimate(){
    try{
      const colSched=headers.findIndex(h=>h.includes('sched'));
      const colActual=headers.findIndex(h=>h.includes('actual'));
      const colSlip=headers.findIndex(h=>h.includes('slip'));
      const s=toPct(colSched>-1?state.row[colSched]:'0%');
      const a=toPct(colActual>-1?state.row[colActual]:'0%');
      const l=toPct(colSlip>-1?state.row[colSlip]:'0%');
      const sEl=document.getElementById('pMiniSched'), aEl=document.getElementById('pMiniActual'), lEl=document.getElementById('pMiniSlip');
      if(sEl){sEl.style.background='#3b82f6'; animateMiniBar(sEl,s,800,v=>`${v.toFixed(2)}%`);}
      if(aEl){aEl.style.background='#10b981'; animateMiniBar(aEl,a,800,v=>`${v.toFixed(2)}%`);}
      if(lEl){const cfg=colorForSlippage(l); lEl.style.background=cfg.bg; lEl.style.color=cfg.text; animateMiniBar(lEl,l,800,v=>`${v.toFixed(2)}%${(cfg.sad && v<=-10)?' ☹️':''}`);}
    }catch{}
  }

  window.openPresentation=function(row){
    state.row=row;
    const cidIdx=headers.findIndex(h=>h.includes('contract id'));
    const projIdx=headers.findIndex(h=>h.includes('project name'));
    const amtIdx=headers.findIndex(h=>h.includes('contract amount'));
    const revAmtIdx=headers.findIndex(h=>h.includes('rev. contract amount','rev contract amount','revised contract amount'));
    const contIdx=headers.findIndex(h=>h.includes('contractor'));
    const statIdx=headers.findIndex(h=>h.includes('status'));
    const ntpIdx=headers.findIndex(h=>h.includes('notice to proceed','ntp'));
    const expIdx=headers.findIndex(h=>h.includes('expiry date','original expiry date'));                 
    const revIdx=headers.findIndex(h=>h.includes('rev. expiry date','revised expiry date','rev expiry date')); 

    document.getElementById('presentCID').textContent = cidIdx>-1 ? (row[cidIdx]||'—') : '—';
    document.getElementById('presentProj').innerHTML = esc(projIdx>-1 ? (row[projIdx]||'—') : '—');
    document.getElementById('presentContractor').innerHTML = esc(contIdx>-1 ? (row[contIdx]||'—') : '—');

    const status = statIdx>-1 ? (row[statIdx]||'—') : '—';
    const chip = document.getElementById('presentStatusChip');
    chip.textContent = status; chip.style.background = statusChipColor(status);

    const amt = parseMoneySafe(amtIdx>-1 ? row[amtIdx] : null);
    const rev = parseMoneySafe(revAmtIdx>-1 ? row[revAmtIdx] : null);
    document.getElementById('presentAmt').textContent = amt!=null ? fmtPHPsafe(amt) : (amtIdx>-1?(row[amtIdx]||'—'):'—');
    document.getElementById('presentRevAmt').textContent = rev!=null ? fmtPHPsafe(rev) : (revAmtIdx>-1?(row[revAmtIdx]||'—'):'—');

    document.getElementById('presentNTP').textContent = fmtDateSafe(ntpIdx>-1 ? row[ntpIdx] : '');
    document.getElementById('presentExpiry').textContent = fmtDateSafe(expIdx>-1 ? row[expIdx] : '');          
    document.getElementById('presentRevExpiry').textContent = fmtDateSafe(revIdx>-1 ? row[revIdx] : '');       

    const remIdx = findCol('remarks');
    document.getElementById('presentRemarks').textContent = remIdx>-1 ? (row[remIdx]||'—') : '—';

    slides.innerHTML=''; thumbs.innerHTML='';
    state.items = collectImageUrls(row);
    if(!state.items.length){
      const s=document.createElement('div'); s.className='present-slide active';
      s.innerHTML=`<img src="${(window.LOGO_FALLBACK||'')}" alt="No image">`;
      slides.appendChild(s);
      counter.textContent='0 / 0';
    }else{
      state.items.forEach((it,i)=>{
        const s=document.createElement('div'); s.className='present-slide'+(i===0?' active':''); s.innerHTML=`<img src="${esc(it.url)}" alt="${esc(it.label)}">`; slides.appendChild(s);
        const th=document.createElement('img'); th.className='present-thumb'+(i===0?' active':''); th.src=it.url; th.alt=it.label; th.onclick=()=>showIndex(i); thumbs.appendChild(th);
      });
      counter.textContent=`1 / ${state.items.length}`;
    }

    overlay.classList.add('show'); document.body.classList.add('no-scroll');
    stopAuto(); startAuto(true);
    setTimeout(barsAnimate, 60);
  };

  document.getElementById('presentClose').onclick = ()=>{ stopAuto(); overlay.classList.remove('show'); document.body.classList.remove('no-scroll'); };
  document.getElementById('presentPlay').onclick = ()=>{ state.timer ? stopAuto() : startAuto(); };
  document.getElementById('presentOpen').onclick = ()=>{ if(state.items.length){ window.open(state.items[state.index].url,'_blank','noopener'); } };
  wrap.querySelector('.present-prev').onclick = ()=>showIndex(state.index-1);
  wrap.querySelector('.present-next').onclick = ()=>showIndex(state.index+1);
  window.addEventListener('keydown', (e)=>{
    if(!overlay.classList.contains('show')) return;
    if(e.key==='Escape'){ document.getElementById('presentClose').click(); }
    else if(e.key==='ArrowRight'){ showIndex(state.index+1); }
    else if(e.key==='ArrowLeft'){ showIndex(state.index-1); }
    else if(e.key===' '){ e.preventDefault(); document.getElementById('presentPlay').click(); }
  });
})();

/* ==== Modal Prev/Next ==== */
(function(){
  let navList = [];
  let navIndex = 0;
  const prevBtn = document.getElementById('modalPrev');
  const nextBtn = document.getElementById('modalNext');
  const posEl   = document.getElementById('modalNavPos');

  function labelPosition(){
    if(!posEl || !navList.length) return;
    posEl.textContent = ` ${navIndex+1} / ${navList.length}`;
  }
  function updateDisables(){
    if(!prevBtn || !nextBtn) return;
    prevBtn.disabled = (navIndex <= 0);
    nextBtn.disabled = (navIndex >= navList.length - 1);
  }
  function indexOfRowInList(row){
    if(!row || !navList.length) return 0;
    let i = navList.indexOf(row);
    if(i >= 0) return i;
    try{
      const cidCol = headers.findIndex(h => String(h||'').toLowerCase().includes('contract id'));
      if(cidCol > -1){
        const key = (row[cidCol]||'').toString().trim().toLowerCase();
        for(let k=0;k<navList.length;k++){
          const v = (navList[k] && navList[k][cidCol]) ? String(navList[k][cidCol]).trim().toLowerCase() : '';
          if(v === key) return k;
        }
      }
    }catch{}
    return 0;
  }

  window.openAtIndex = function(i){
    if(!navList.length) return;
    const N = navList.length;
    const nextI = Math.max(0, Math.min(i, N-1));
    navIndex = nextI;
    showDetail(navList[navIndex]);
    labelPosition();
    updateDisables();
  };

  const origRenderGrid = window.renderGrid;
  window.renderGrid = function(rows){
    const ret = origRenderGrid.apply(this, arguments);
    try{
      const cards = document.querySelectorAll('#grid .card');
      const list = nonEmptyRows(window.lastRenderedRows && window.lastRenderedRows.length ? window.lastRenderedRows : rows);
      cards.forEach((card)=>{
        const idx = Number(card.dataset.rowIndex || '-1');
        if(Number.isFinite(idx) && idx > -1){
          card.onclick = ()=>{
            navList = list.slice();
            openAtIndex(idx);
          };
        }
      });
    }catch{}
    return ret;
  };

  document.getElementById('grid').addEventListener('click', (e)=>{
    const card = e.target.closest('.card');
    if(!card) return;
    const idx = Number(card.dataset.rowIndex || '-1');
    const list = nonEmptyRows(window.lastRenderedRows && window.lastRenderedRows.length ? window.lastRenderedRows : window.records);
    if(Number.isFinite(idx) && idx > -1 && list[idx]){
      navList = list.slice();
      openAtIndex(idx);
    }
  });

  if(prevBtn) prevBtn.addEventListener('click', (e)=>{ e.stopPropagation(); openAtIndex(navIndex-1); });
  if(nextBtn) nextBtn.addEventListener('click', (e)=>{ e.stopPropagation(); openAtIndex(navIndex+1); });

  const origShowDetail = window.showDetail;
  window.showDetail = function(row){
    const ret = origShowDetail.apply(this, arguments);
    try{
      if(navList && navList.length){
        navIndex = indexOfRowInList(row);
        labelPosition();
        updateDisables();
      }
    }catch{}
    return ret;
  };
})();

/* init */
loadData();
if('serviceWorker' in navigator){ navigator.serviceWorker.register('service-worker.js').catch(console.error); }
</script>
</body>
</html>
