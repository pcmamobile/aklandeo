<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>PCMA Mobile V3.1</title>

<link rel="icon" type="image/png" sizes="32x32" href="https://i.ibb.co/RRJpHk2/PCMA-logo-1.png">
<link rel="apple-touch-icon" sizes="180x180" href="https://i.ibb.co/RRJpHk2/PCMA-logo-1.png">
<link rel="manifest" href="manifest.json" />
<meta name="theme-color" content="#2563eb" />

<style>
  :root{
    --brand:#2563eb;
    --brand-dark:#1e40af;
    --bg:#f4f6f8;
  }
  body{font-family:"Segoe UI",Arial,sans-serif;margin:0;background:var(--bg);color:#111;}

  /* ===== HEADER (PC ONLY) ===== */
  header{
    background:linear-gradient(135deg,#2563eb,#1e40af);
    color:white;padding:12px 16px;border-bottom:3px solid #1e3a8a;
    position:sticky;top:0;z-index:200;
  }
  .header-container{display:flex;align-items:center;justify-content:space-between;gap:12px;max-width:1100px;margin:0 auto;}
  .brand{display:flex;align-items:center;gap:12px;}
  .header-logo{height:70px;width:auto;border-radius:10px;box-shadow:0 3px 6px rgba(0,0,0,0.25);} 
  .header-title{margin:0;font-size:1.8rem;font-weight:700;letter-spacing:.5px;}
  .filter-toggle-btn{
    background:rgba(255,255,255,.18);border:1px solid rgba(255,255,255,.6);color:#fff;
    font-weight:800;padding:6px 10px;border-radius:9px;cursor:pointer;transition:background .15s ease,transform .05s ease;
    font-size:.85rem;
  }

  /* ===== STICKY SEARCH BAR (SMALL) ===== */
  #filters{
    position:sticky;
    top:0;
    z-index:180;
    display:flex;
    flex-direction:column;
    gap:6px;
    margin:0 auto 6px auto;
    padding:6px 10px;
    background:#fff;
    border:1px solid #e5e7eb;
    border-radius:0 0 10px 10px;
    box-shadow:0 2px 6px rgba(0,0,0,.03);
    max-width:1100px;
  }
  @media (min-width:769px){
    #filters{top:82px;border-radius:10px;}
  }
  .top-actions{display:flex;gap:6px;align-items:center;}
  #toggleMoreFilters{
    background:#2563eb;color:#fff;border:none;border-radius:8px;padding:5px 10px;
    font-weight:800;cursor:pointer;display:inline-flex;align-items:center;gap:4px;font-size:.85rem;height:32px;
  }

  .filter-combo{width:100%;}
  .filter-combo .input-icon-wrap{position:relative;display:block;width:100%;}
  .filter-combo input{
    font-size:.95rem;
    padding:7px 10px;
    border-radius:9px;
    border:2px solid #cbd5e1;
    background:#f8fafc;
    outline:none;
    transition:border-color .15s ease,box-shadow .15s ease;
    width:100%;
    box-sizing:border-box;
    height:34px;
  }
  .filter-combo input:focus{border-color:#2563eb;box-shadow:0 0 0 3px rgba(37,99,235,.08);}

  #moreFilters{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(170px,1fr));
    gap:6px;
    margin-top:2px;
  }
  #moreFilters.hidden{display:none;}
  #moreFilters label{display:flex;flex-direction:column;gap:4px;font-size:.8rem;color:#0f172a;font-weight:700;}
  #moreFilters select{
    font-size:.9rem;padding:6px 8px;border-radius:8px;border:2px solid #cbd5e1;background:#f8fafc;
    outline:none;transition:border-color .15s ease,box-shadow .15s ease;height:33px;
  }
  #moreFilters select:focus{border-color:#2563eb;box-shadow:0 0 0 3px rgba(37,99,235,.08);}
  #applyFilter,#clearFilter{
    padding:7px 8px;font-size:.9rem;border-radius:8px;font-weight:800;height:33px;cursor:pointer;border:none;
  }
  #applyFilter{background:#2563eb;color:#fff;}
  #clearFilter{background:#e5e7eb;color:#111;}

  /* Hide header on mobile/app */
  @media (max-width:768px){
    header{display:none;}
    #filters{top:0;border-radius:0;}
  }

  main{max-width:1100px;margin:6px auto 10px auto;padding:5px;}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:10px;}
  #resultInfo{max-width:1100px;margin:4px auto 10px auto;padding:0 6px;color:#334155;font-weight:800;}

  /* Cards */
  .card{background:#fff;border-radius:12px;box-shadow:0 3px 8px rgba(0,0,0,.1);cursor:pointer;transition:transform .15s,box-shadow .15s;overflow:hidden;display:flex;align-items:center;gap:12px;padding:10px;}
  .card:hover{transform:scale(1.01);box-shadow:0 6px 12px rgba(0,0,0,.15);} 


.card-thumb{
  width:40px;
  height:40px;
  object-fit:cover;
  border-radius:8px;
  background:#eee;
  flex:0 0 auto;
}





  .card-content{padding:4px 2px;flex:1;}
  .contract-id{font-size:1.2rem;font-weight:900;color:#8b0000;letter-spacing:.2px;}
  .engineer-name{color:#2563eb;font-weight:700;}
  .status{font-weight:700;margin-top:4px;padding:2px 10px;border-radius:999px;display:inline-block;color:#fff;}
  mark{background:#fef08a;padding:0 .15em;border-radius:.2em;}



.card-content{
  font-size: 0.75rem;   /* 75% */
  line-height: 1.05;
}




  /* ===== Modal FULLSCREEN ===== */
  #modalBg{
    display:none;
    position:fixed;
    inset:0;
    background:rgba(0,0,0,.45);
    justify-content:center;
    align-items:center;
    z-index:200;
  }
  #modalBg.show{display:flex;}
  #modalBox{
    background:#fff;
    width:100vw;
    height:100vh;
    max-width:100vw;
    max-height:100vh;
    border-radius:0;
    display:flex;
    flex-direction:column;
    overflow:hidden;
  }
  .modal-top{
    position:sticky;top:0;z-index:5;display:flex;align-items:center;justify-content:space-between;gap:8px;
    background:#f97316;color:#fff;padding:10px 14px;border-bottom:1px solid rgba(0,0,0,.08);box-shadow:0 2px 4px rgba(0,0,0,.08);
  }
  .modal-top-left{display:flex;align-items:center;gap:10px;}
  .modal-top-logo{width:28px;height:28px;border-radius:6px;object-fit:cover;}
  .modal-top-cid{font-weight:900;color:#fff;}
  .modal-close-btn{background:#fff;border:none;color:#f97316;font-weight:900;padding:6px 12px;border-radius:8px;cursor:pointer;line-height:1;}
  .modal-close-btn:hover{background:#ffe8d7;}

  /* hide old inline prev/next text group */
  .modal-nav{display:none !important;}

  /* scrollable body */
  #modalBody{
    flex:1 1 auto;
    overflow:auto;
    background:#fff;
  }
  #modalContent{display:flex;flex-direction:column;gap:6px;padding:14px;max-width:1100px;margin:0 auto;}
  #modalButtons{padding:0 14px 14px;max-width:1100px;margin:0 auto;}
  #modalImages{padding:0 14px 12px 14px;max-width:1100px;margin:0 auto;}

  .detail-row{display:flex;justify-content:space-between;flex-wrap:wrap;padding:6px 0;border-bottom:1px solid #eee;}
  .detail-label{font-size:.85rem;color:#475569;font-weight:700;}
  .detail-value{font-weight:800;color:#111;margin-left:8px;padding:2px 10px;border-radius:999px;background:#f3f4f6;}
  .detail-value.status-badge{color:#fff;background:#2563eb;}

  .detail-value.project-engineer{background:#bfdbfe;color:#1e3a8a;}
  .detail-value.project-inspector{background:#c7d2fe;color:#3730a3;}
  .detail-value.resident-engineer{background:#bbf7d0;color:#166534;}
  .detail-value.quantity-engineer{background:#fbcfe8;color:#831843;}
  .detail-value.materials-engineer{background:#fed7aa;color:#78350f;}

  .pair-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px;}
  .pair-box{display:flex;flex-direction:column;justify-content:center;align-items:flex-start;background:#e0f2fe;border:1px solid #bfdbfe;border-radius:10px;padding:10px;min-height:40px;}
  .pair-label{display:block;font-size:.8rem;color:#475569;font-weight:700;margin-bottom:4px;}
  .pair-value{display:block;font-weight:900;color:#0f172a;}
  .pair-value.neg{color:#dc2626;}
  .pair-box.span-2{grid-column:1/-1;}

  .center-row{justify-content:center !important;flex-direction:column !important;align-items:center !important;text-align:center;}
  .center-row .detail-label{width:100%;text-align:center;}
  .center-row .detail-value{margin-left:0;}

  .detail-row.compact{display:flex;flex-direction:row;align-items:center;gap:8px;padding:4px 6px;}
  .detail-row.compact .detail-label{min-width:48px;text-align:center;background:#e2e8f0;border-radius:999px;padding:2px 8px;margin-right:8px;font-weight:900;}
  .detail-row.compact .detail-value{background:transparent;padding:0;}

  .detail-row.emph-orange{background:#ffedd5;border-radius:10px;padding:8px;border-bottom:none;}
  .detail-row.emph-orange .detail-label{color:#7c2d12;}
  .detail-row.emph-orange .detail-value{background:transparent;}

  .mini-bars{display:flex;flex-direction:column;gap:6px;margin-top:10px;}
  .mini-row{display:flex;align-items:center;gap:10px;}
  .mini-label{width:82px;text-align:left;font-weight:900;color:#0f172a;letter-spacing:.2px;}
  .mini-bar{flex:1;height:18px;background:#e5e7eb;border-radius:999px;overflow:hidden;}
  .mini-fill{height:100%;width:0%;display:flex;align-items:center;justify-content:center;font-size:.8rem;font-weight:800;color:#fff;transition:width 650ms ease-out;white-space:nowrap;padding:0 6px;}

  .progress-wrap{margin-top:12px;}
  .progress-label{font-weight:800;color:#0f172a;margin-bottom:6px;font-size:1.05rem;text-align:center;}
  .progress-bar{width:100%;background:#e5e7eb;border-radius:12px;height:28px;overflow:hidden;position:relative;}
  .progress-fill{height:100%;border-radius:12px;text-align:center;line-height:28px;font-weight:800;color:#fff;font-size:1rem;width:0%;transition:width 900ms ease-out;white-space:nowrap;padding:0 8px;}

  #modalButtons button{width:100%;padding:14px;margin:4px 0;border-radius:8px;font-size:1rem;border:none;cursor:pointer;font-weight:700;}
  #uploadBtn{background:#007bff;color:#fff;} 
  #viewPictureBtn{background:#16a34a;color:#fff;} 
  #presentBtn{background:#111827;color:#fff;}

  /* NEW: floating modal arrows */
  .modal-arrow{
    position:fixed;
    top:50%;
    transform:translateY(-50%);
    background:rgba(0,0,0,0.2);
    backdrop-filter:blur(2px);
    border:none;
    width:48px;
    height:72px;
    border-radius:999px;
    display:flex;
    align-items:center;
    justify-content:center;
    cursor:pointer;
    z-index:210;
  }
  #modalPrevFloat{left:10px;}
  #modalNextFloat{right:10px;}
  .modal-arrow svg{
    width:26px;
    height:26px;
    stroke:#fff;
  }
  @media (max-width:768px){
    .modal-arrow{width:40px;height:60px;}
  }

  /* ===== Floating gallery (unchanged) ===== */
  .gallery-overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);backdrop-filter:blur(2px);display:none;align-items:center;justify-content:center;z-index:300;}
  .gallery-overlay.show{display:flex;}
  .gallery-box{background:#0b1220;color:#e5e7eb;width:min(100svw,1100px);height:min(100svh,92svh);border-radius:14px;overflow:hidden;display:flex;flex-direction:column;box-shadow:0 16px 48px rgba(0,0,0,.45);}
  .gallery-top{display:flex;align-items:center;gap:10px;justify-content:space-between;padding:10px 14px;background:linear-gradient(135deg,#2563eb,#1e40af);border-bottom:3px solid #1e3a8a;}
  .gallery-title{font-weight:900;letter-spacing:.4px;}
  .gallery-actions{display:flex;align-items:center;gap:8px;}
  .gallery-btn{background:#fff;color:#1e40af;border:none;border-radius:8px;padding:6px 12px;font-weight:900;cursor:pointer;}
  .gallery-main{position:relative;flex:1;background:#0f172a;display:flex;align-items:center;justify-content:center;overflow:hidden;}
  .gallery-img{max-width:100%;max-height:100%;object-fit:contain;display:block;}
  .nav-btn{position:absolute;top:50%;transform:translateY(-50%);border:none;background:rgba(0,0,0,.35);color:#fff;border-radius:999px;width:44px;height:44px;cursor:pointer;display:flex;align-items:center;justify-content:center;}
  .nav-prev{left:12px;}
  .nav-next{right:12px;}
  .gallery-bottom{padding:10px;background:#0b1220;border-top:1px solid #1f2a44;display:flex;flex-direction:column;gap:8px;}
  .thumb-strip{display:flex;gap:8px;overflow:auto;scrollbar-width:thin;padding-bottom:2px;}
  .thumb{width:80px;height:60px;object-fit:cover;border-radius:8px;border:2px solid transparent;opacity:.8;cursor:pointer;background:#111827;}
  .thumb.active{border-color:#86efac;opacity:1;}

  /* ===== Projector Mode (unchanged but labels white) ===== */
  .present-overlay{position:fixed;inset:0;background:#070b16;display:none;align-items:center;justify-content:center;z-index:5000;}
  .present-overlay.show{display:flex;}
  .present-box{width:min(100svw,1280px);height:min(100svh,96svh);background:linear-gradient(180deg,#0b1220 0%,#0b1220 55%,#0a0f1c 100%);border:1px solid #1f2a44;border-radius:18px;overflow:hidden;box-shadow:0 30px 100px rgba(0,0,0,.6);display:grid;grid-template-rows:auto 1fr auto;}
  .present-top{display:flex;align-items:center;justify-content:space-between;padding:16px 20px;background:linear-gradient(135deg,#2563eb,#1e40af);border-bottom:4px solid #1e3a8a;}
  .present-cid{font-size:2rem;font-weight:900;color:#fff}
  .present-actions{display:flex;gap:10px}
  .present-btn{background:#fff;color:#1e40af;border:none;border-radius:10px;padding:10px 14px;font-weight:900;cursor:pointer}
  .present-content{display:grid;grid-template-columns:1.15fr .85fr;gap:16px;padding:16px;overflow:hidden}
  @media(max-width:980px){.present-content{grid-template-columns:1fr}}
  .present-left{position:relative;background:#0f172a;border:1px solid #1f2a44;border-radius:12px;overflow:hidden}
  .present-slide{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;opacity:0;transition:opacity .4s ease}
  .present-slide.active{opacity:1}
  .present-left .nav{position:absolute;top:50%;transform:translateY(-50%);background:rgba(0,0,0,.35);border:none;width:56px;height:56px;border-radius:999px;color:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center}
  .present-prev{left:10px}.present-next{right:10px}
  .present-thumbs{position:absolute;left:0;right:0;bottom:0;background:rgba(7,11,22,.82);padding:8px;display:flex;gap:8px;overflow:auto;border-top:1px solid #1f2a44}
  .present-thumb{width:100px;height:70px;object-fit:cover;border-radius:8px;border:2px solid transparent;opacity:.8;cursor:pointer;background:#111827;flex:0 0 auto}
  .present-thumb.active{opacity:1;border-color:#86efac}
  .present-right{display:flex;flex-direction:column;gap:12px}
  .present-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .present-cell{background:#0f172a;border:1px solid #1f2a44;border-radius:12px;padding:14px}
  .present-cell.span-2{grid-column:1/-1}
  .present-title{font-size:.8rem;color:#93c5fd;font-weight:800;margin-bottom:6px;letter-spacing:.08em;text-transform:uppercase}
  .present-value{font-size:1.2rem;color:#e5e7eb;font-weight:800;line-height:1.35}
  .present-grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
  .present-cell-small{background:#0f172a;border:1px dashed #1f2a44;border-radius:12px;padding:12px}
  .present-remarks{white-space:pre-wrap;line-height:1.45;color:#e9efff}
  .status-chip{display:inline-block;padding:6px 12px;border-radius:999px;font-weight:900;color:#fff}
  /* your request: make SCHED / ACTUAL / SLIPPAGE text white */
  .present-right .mini-label{color:#fff !important;}

  @media (max-width:480px){
    .detail-row{flex-direction:column;align-items:flex-start;gap:4px;}
  }
</style>
</head>
<body>
<header>
  <div class="header-container">
    <div class="brand">
      <img src="https://drive.google.com/thumbnail?id=1VanVX82ANGfKA8jcGZL8cVDQh4EuN8-r&sz=s800" alt="PCMA Logo" class="header-logo" decoding="async"/>
      <h2 class="header-title">PCMA Mobile V3.1</h2>
    </div>
    <button id="toggleFilters" class="filter-toggle-btn" title="Show/Hide Search">Hide Search</button>
  </div>
</header>

<main>
  <!-- small sticky search -->
  <div id="filters">
    <div class="top-actions">
      <button id="toggleMoreFilters">Filter</button>
    </div>
    <label class="filter-combo">
      <span class="input-icon-wrap">
        <input id="filterCombo" type="text" autocomplete="off" />
      </span>
    </label>
    <div id="moreFilters" class="hidden">
      <label>YEAR <select id="filterYear"><option value="">All</option></select></label>
      <label>PROJECT ENGINEER <select id="filterEngineer"><option value="">All</option></select></label>
      <label>CONTRACTOR <select id="filterContractor"><option value="">All</option></select></label>
      <label>STATUS <select id="filterStatus"><option value="">All</option></select></label>
      <button id="applyFilter">Apply</button>
      <button id="clearFilter">Clear</button>
    </div>
  </div>

  <div id="resultInfo" class="hidden"></div>
  <div id="grid" class="grid hidden"></div>
</main>

<!-- MODAL (full screen) -->
<div id="modalBg" role="dialog" aria-modal="true" aria-labelledby="modalCID">
  <!-- floating arrows -->
  <button id="modalPrevFloat" class="modal-arrow" aria-label="Previous">
    <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <polyline points="15 18 9 12 15 6"></polyline>
    </svg>
  </button>
  <button id="modalNextFloat" class="modal-arrow" aria-label="Next">
    <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </button>

  <div id="modalBox">
    <div class="modal-top">
      <div class="modal-top-left">
        <img class="modal-top-logo" src="https://i.ibb.co/RRJpHk2/PCMA-logo-1.png" alt="PCMA" />
        <div id="modalCID" class="modal-top-cid">—</div>
      </div>
      <!-- old nav is hidden via CSS -->
      <button id="closeModalTop" class="modal-close-btn" aria-label="Close modal">Close</button>
    </div>
    <div id="modalBody">
      <div id="modalContent"></div>
      <div id="modalButtons"></div>
      <div id="modalImages"></div>
    </div>
  </div>
</div>

<!-- GALLERY -->
<div id="galleryOverlay" class="gallery-overlay" role="dialog" aria-modal="true" aria-labelledby="galleryCID">
  <div class="gallery-box" id="galleryBox">
    <div class="gallery-top">
      <div class="gallery-title" id="galleryCID">—</div>
      <div class="gallery-actions">
        <a id="galleryOpen" class="gallery-btn" href="#" target="_blank" rel="noopener">Open</a>
        <button id="galleryClose" class="gallery-btn" aria-label="Close gallery">Close</button>
      </div>
    </div>
    <div class="gallery-main" id="galleryMain">
      <button class="nav-btn nav-prev" id="galleryPrev" aria-label="Previous image"><span>&lt;</span></button>
      <img id="galleryImg" class="gallery-img" alt="Gallery image"/>
      <button class="nav-btn nav-next" id="galleryNext" aria-label="Next image"><span>&gt;</span></button>
    </div>
    <div class="gallery-bottom">
      <div class="bottom-row">
        <div class="gallery-counter" id="galleryCounter">0 / 0</div>
      </div>
      <div class="thumb-strip" id="galleryThumbs"></div>
    </div>
  </div>
</div>

<!-- PROJECTOR MODE (restored) -->
<div id="presentOverlay" class="present-overlay" aria-modal="true" role="dialog">
  <div class="present-box">
    <div class="present-top">
      <div id="presentCID" class="present-cid">—</div>
      <div class="present-actions">
        <button id="presentPlay" class="present-btn" title="Play/Pause">Play</button>
        <button id="presentOpen" class="present-btn" title="Open Current Image">Open</button>
        <button id="presentClose" class="present-btn" title="Close">Close</button>
      </div>
    </div>
    <div class="present-content">
      <div class="present-left">
        <button class="nav present-prev" aria-label="Prev" id="presentPrev">‹</button>
        <div id="presentSlides"></div>
        <div class="present-thumbs" id="presentThumbs"></div>
        <button class="nav present-next" aria-label="Next" id="presentNext">›</button>
      </div>
      <div class="present-right">
        <div class="present-grid">
          <div class="present-cell span-2"><div class="present-title">Project Name</div><div id="presentProj" class="present-value">—</div></div>
          <div class="present-cell span-2"><div class="present-title">Contractor</div><div id="presentContractor" class="present-value">—</div></div>
          <div class="present-cell"><div class="present-title">Contract Amount</div><div id="presentAmt" class="present-value">—</div></div>
          <div class="present-cell"><div class="present-title">Rev. Contract Amount</div><div id="presentRevAmt" class="present-value">—</div></div>
          <div class="present-cell span-2">
            <div class="present-title">NTP / Expiry / Rev.</div>
            <div class="present-grid-3">
              <div class="present-cell-small"><div class="present-title">NTP</div><div id="presentNTP" class="present-value">—</div></div>
              <div class="present-cell-small"><div class="present-title">Expiry</div><div id="presentExpiry" class="present-value">—</div></div>
              <div class="present-cell-small"><div class="present-title">Rev. Expiry</div><div id="presentRevExpiry" class="present-value">—</div></div>
            </div>
          </div>
          <div class="present-cell span-2">
            <div class="present-title">Schedule / Actual / Slippage</div>
            <div class="mini-bars">
              <div class="mini-row"><div class="mini-label">SCHED</div><div class="mini-bar"><div id="pMiniSched" class="mini-fill"></div></div></div>
              <div class="mini-row"><div class="mini-label">ACTUAL</div><div class="mini-bar"><div id="pMiniActual" class="mini-fill"></div></div></div>
              <div class="mini-row"><div class="mini-label">SLIPPAGE</div><div class="mini-bar"><div id="pMiniSlip" class="mini-fill"></div></div></div>
            </div>
          </div>
          <div class="present-cell span-2"><div class="present-title">Remarks</div><div id="presentRemarks" class="present-remarks">—</div></div>
          <div class="present-cell span-2"><div class="present-title">Status</div><div class="present-value"><span id="presentStatusChip" class="status-chip">—</span></div></div>
        </div>
      </div>
    </div>
    <div class="present-footer" style="padding:10px 16px;color:#94a3b8;font-weight:800;display:flex;justify-content:space-between;">
      <div id="presentCounter">0 / 0</div>
      <div>Press ← / → to navigate • Esc to close</div>
    </div>
  </div>
</div>

<script>
/* ===== CONFIG ===== */
const SHEET_ID="1LSYLZ7tfSeVupQMPsCOHG4SlnzPQqOAIe03QI1qRMr8";
const RANGE="APP";
const API_KEY="AIzaSyCz6fNJr3ecn-M2HActqM1aCXbxqRLj2e8";
const LOGO_FALLBACK="https://i.ibb.co/RRJpHk2/PCMA-logo-1.png";

/* ===== ELEMENTS ===== */
const grid=document.getElementById('grid');
const resultInfo=document.getElementById('resultInfo');
const filtersBox=document.getElementById('filters');
const toggleFiltersBtn=document.getElementById('toggleFilters');

const filterCombo=document.getElementById('filterCombo');
const filterYear=document.getElementById('filterYear');
const filterStatus=document.getElementById('filterStatus');
const filterContractor=document.getElementById('filterContractor');
const filterEngineer=document.getElementById('filterEngineer');
const applyFilterBtn=document.getElementById('applyFilter');
const clearFilterBtn=document.getElementById('clearFilter');
const moreFiltersBox=document.getElementById('moreFilters');
const toggleMoreFiltersBtn=document.getElementById('toggleMoreFilters');

const modalBg=document.getElementById('modalBg');
const modalContent=document.getElementById('modalContent');
const modalButtons=document.getElementById('modalButtons');
const modalImages=document.getElementById('modalImages');
const closeModalTop=document.getElementById('closeModalTop');
const modalCID=document.getElementById('modalCID');
const modalPrevFloat=document.getElementById('modalPrevFloat');
const modalNextFloat=document.getElementById('modalNextFloat');

const galleryOverlay = document.getElementById('galleryOverlay');
const galleryCID = document.getElementById('galleryCID');
const galleryImg = document.getElementById('galleryImg');
const galleryPrev = document.getElementById('galleryPrev');
const galleryNext = document.getElementById('galleryNext');
const galleryCounter = document.getElementById('galleryCounter');
const galleryThumbs = document.getElementById('galleryThumbs');
const galleryOpenLink = document.getElementById('galleryOpen');
const galleryCloseBtn = document.getElementById('galleryClose');
const galleryMain = document.getElementById('galleryMain');

const presentOverlay=document.getElementById('presentOverlay');
const presentSlides=document.getElementById('presentSlides');
const presentThumbs=document.getElementById('presentThumbs');
const presentCID=document.getElementById('presentCID');
const presentProj=document.getElementById('presentProj');
const presentContractor=document.getElementById('presentContractor');
const presentAmt=document.getElementById('presentAmt');
const presentRevAmt=document.getElementById('presentRevAmt');
const presentNTP=document.getElementById('presentNTP');
const presentExpiry=document.getElementById('presentExpiry');
const presentRevExpiry=document.getElementById('presentRevExpiry');
const presentRemarks=document.getElementById('presentRemarks');
const presentStatusChip=document.getElementById('presentStatusChip');
const presentCounter=document.getElementById('presentCounter');
const presentPrev=document.getElementById('presentPrev');
const presentNext=document.getElementById('presentNext');
const presentPlay=document.getElementById('presentPlay');
const presentOpen=document.getElementById('presentOpen');
const presentClose=document.getElementById('presentClose');

/* ===== STATE ===== */
let headers=[],records=[]; let lastRenderedRows=[]; let galleryItems=[]; let galleryIndex=0; let activeCID='—';
let modalNavList=[]; let modalNavIndex=0;
let presentState={items:[],index:0,row:null,timer:null,delay:6000};

/* ===== HELPERS ===== */
function isValidUrl(u){ try{ const x=new URL(u); return x.protocol==='http:'||x.protocol==='https:'; }catch{return false;} }
function toPct(val,fallback=0){
  if(val==null) return fallback;
  const m=String(val).replace(',', '.').match(/-?\d+(\.\d+)?/);
  return m?parseFloat(m[0]):fallback;
}
function colorForSlippage(num){
  if(num>0) return {bg:'#10b981',text:'#fff',sad:false};
  if(num<=0 && num>-5) return {bg:'#fecaca',text:'#7f1d1d',sad:false};
  if(num<=-5 && num>-10) return {bg:'#f87171',text:'#fff',sad:true};
  if(num<=-10) return {bg:'#dc2626',text:'#fff',sad:true};
  return {bg:'#6b7280',text:'#fff',sad:false};
}
function animateMiniBar(fillEl,value,duration=800,formatFn=null){
  const sign=value<0?-1:1; const endAbs=Math.min(Math.abs(value),100);
  const startTime=performance.now();
  function step(now){
    const t=Math.min(1,(now-startTime)/duration);
    const cur=endAbs*t; fillEl.style.width=cur+'%';
    const display=sign*cur; fillEl.textContent=formatFn?formatFn(display):`${display.toFixed(2)}%`;
    if(t<1) requestAnimationFrame(step);
    else { fillEl.style.width=endAbs+'%'; fillEl.textContent=formatFn?formatFn(sign*endAbs):`${(sign*endAbs).toFixed(2)}%`; }
  }
  requestAnimationFrame(step);
}
function parseMoney(v){ if(v==null) return null; const s=String(v).replace(/[^0-9.\-]/g,''); const n=parseFloat(s); return Number.isFinite(n)?n:null; }
function fmtPHP(n){ try{ return '₱ ' + Number(n).toLocaleString('en-PH',{minimumFractionDigits:2, maximumFractionDigits:2}); }catch{ return '₱ ' + n; } }
function findCol(){ const keys=[...arguments].map(k=>String(k).toLowerCase()); return headers.findIndex(h=> keys.some(k=> h.includes(k))); }

/* ===== DATA LOAD ===== */
async function loadData(){
  const url=`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${RANGE}?key=${API_KEY}`;
  try{
    const res=await fetch(url);
    const data=await res.json();
    if(!data.values || !data.values.length) throw new Error('No data returned');

    const keyHints = ['contract id','project name','location','status'];
    let headerRowIndex = 0;
    for(let i=0;i<data.values.length;i++){
      const row = (data.values[i]||[]).map(c=>String(c||'').trim().toLowerCase());
      const hit = keyHints.some(h => row.some(cell => cell.includes(h)));
      if(hit){ headerRowIndex = i; break; }
    }

    headers = (data.values[headerRowIndex]||[]).map(h=>(h||'').trim().toLowerCase().replace(/[:]+/g,''));
    records = data.values.slice(headerRowIndex+1);

    populateFilterOptions();
    restoreFilterState();

    const all = records.filter(r=>r && r.join('').trim());
    renderGrid(all);
    grid.classList.remove('hidden');
    resultInfo.textContent = `${all.length} results`;
    resultInfo.classList.remove('hidden');
  }catch(e){
    console.error(e);
    grid.classList.remove('hidden');
    grid.innerHTML = `<div style="grid-column:1/-1;text-align:center;padding:20px;color:#b91c1c;">Failed to load data.</div>`;
  }
}

/* ===== FILTERS ===== */
function populateFilterOptions(){
  const years=new Set(),contractors=new Set(),engineers=new Set(),statuses=new Set();
  const colYear=headers.findIndex(h=>h.includes('year'));
  const colContractor=headers.findIndex(h=>h.includes('contractor'));
  const colEngineer=headers.findIndex(h=>h.includes('project engineer'));
  const colStatus=headers.findIndex(h=>h.includes('status'));
  records.forEach(r=>{
    if(colYear>=0&&r[colYear])years.add(r[colYear]);
    if(colContractor>=0&&r[colContractor])contractors.add(r[colContractor]);
    if(colEngineer>=0&&r[colEngineer])engineers.add(r[colEngineer]);
    if(colStatus>=0&&r[colStatus])statuses.add(String(r[colStatus]).trim());
  });
  filterYear.innerHTML='<option value="">All</option>'+[...years].sort().map(y=>`<option value="${y}">${y}</option>`).join('');
  filterContractor.innerHTML='<option value="">All</option>'+[...contractors].sort().map(c=>`<option value="${c}">${c}</option>`).join('');
  filterEngineer.innerHTML='<option value="">All</option>'+[...engineers].sort().map(e=>`<option value="${e}">${e}</option>`).join('');
  filterStatus.innerHTML='<option value="">All</option>'+[...statuses].sort().map(s=>`<option value="${s}">${s}</option>`).join('');
}
function saveFilterState(){
  const state={
    combo:filterCombo.value||'',
    year:filterYear.value||'',
    status:filterStatus.value||'',
    contractor:filterContractor.value||'',
    engineer:filterEngineer.value||'',
    more:!moreFiltersBox.classList.contains('hidden')
  };
  localStorage.setItem('pcma_filters', JSON.stringify(state));
}
function restoreFilterState(){
  try{
    const raw=localStorage.getItem('pcma_filters'); if(!raw) return;
    const s=JSON.parse(raw);
    filterCombo.value=s.combo||'';
    filterYear.value=s.year||'';
    filterStatus.value=s.status||'';
    filterContractor.value=s.contractor||'';
    filterEngineer.value=s.engineer||'';
    if(s.more) moreFiltersBox.classList.remove('hidden');
  }catch{}
}

function filterData(text, year, engineer, contractor, status){
  const q=(text||'').toLowerCase().trim();
  const idx={
    cid: headers.findIndex(h=>h.includes('contract id')),
    project: headers.findIndex(h=>h.includes('project name')),
    location: headers.findIndex(h=>h.includes('location')),
    pe: headers.findIndex(h=>h.includes('project engineer')),
    pi: headers.findIndex(h=>h.includes('project inspector')),
    re: headers.findIndex(h=>h.includes('resident engineer')),
    qe: headers.findIndex(h=>h.includes('quantity engineer')),
    me: headers.findIndex(h=>h.includes('materials engineer')),
    contractor: headers.findIndex(h=>h.includes('contractor')),
    status: headers.findIndex(h=>h.includes('status')),
    year: headers.findIndex(h=>h.includes('year')),
  };
  return records.filter(r=>{
    if(!r || !r.join('').trim()) return false;
    let textOK = true;
    if(q){
      textOK = [
        idx.cid, idx.project, idx.location,
        idx.pe, idx.pi, idx.re, idx.qe, idx.me,
        idx.contractor, idx.status, idx.year
      ].some(ci => ci>=0 && String(r[ci]||'').toLowerCase().includes(q));
    }
    if(!textOK) return false;
    if(year){ if(!(idx.year>=0) || String(r[idx.year]||'').toLowerCase() !== year) return false; }
    if(engineer){ if(!(idx.pe>=0) || String(r[idx.pe]||'').toLowerCase() !== engineer) return false; }
    if(contractor){ if(!(idx.contractor>=0) || String(r[idx.contractor]||'').toLowerCase() !== contractor) return false; }
    if(status){ if(!(idx.status>=0) || String(r[idx.status]||'').toLowerCase() !== status) return false; }
    return true;
  });
}

function applyFilters(){
  const combo=(filterCombo.value||'');
  const y=(filterYear.value||'').toLowerCase();
  const s=(filterStatus.value||'').toLowerCase();
  const c=(filterContractor.value||'').toLowerCase();
  const e=(filterEngineer.value||'').toLowerCase();

  const filtered = filterData(combo, y, e, c, s);
  grid.classList.remove('hidden');
  renderGrid(filtered.length?filtered:[]);
  resultInfo.textContent = `${filtered.length} result${filtered.length!==1?'s':''}`;
  resultInfo.classList.remove('hidden');
  saveFilterState();
}
function clearFilters(){
  filterCombo.value='';
  filterYear.value='';
  filterStatus.value='';
  filterContractor.value='';
  filterEngineer.value='';
  saveFilterState();
  const all = records.filter(r=>r && r.join('').trim());
  renderGrid(all);
  resultInfo.textContent = `${all.length} results`;
  resultInfo.classList.remove('hidden');
  grid.classList.remove('hidden');
}

/* live search */
filterCombo.addEventListener('input', ()=>{
  const rows = filterData(filterCombo.value, '', '', '', '');
  grid.classList.remove('hidden');
  renderGrid(rows);
  resultInfo.textContent = `${rows.length} result${rows.length!==1?'s':''}`;
  resultInfo.classList.remove('hidden');
  saveFilterState();
});

/* Apply / Clear: close dropdown */
applyFilterBtn.addEventListener('click', (e)=>{
  e.stopPropagation();
  applyFilters();
  moreFiltersBox.classList.add('hidden');
  const st = JSON.parse(localStorage.getItem('pcma_filters') || '{}');
  st.more = false;
  localStorage.setItem('pcma_filters', JSON.stringify(st));
});
clearFilterBtn.addEventListener('click', (e)=>{
  e.stopPropagation();
  clearFilters();
  moreFiltersBox.classList.add('hidden');
  const st = JSON.parse(localStorage.getItem('pcma_filters') || '{}');
  st.more = false;
  localStorage.setItem('pcma_filters', JSON.stringify(st));
});
toggleMoreFiltersBtn.addEventListener('click', (e)=>{
  e.stopPropagation();
  moreFiltersBox.classList.toggle('hidden');
  saveFilterState();
});

/* desktop show/hide whole filter */
toggleFiltersBtn.addEventListener('click', ()=>{
  if(window.innerWidth<=768) return;
  const isHidden = filtersBox.style.display==='none';
  filtersBox.style.display = isHidden?'flex':'none';
  toggleFiltersBtn.textContent = isHidden?'Hide Search':'Show Search';
});

/* ===== GRID ===== */









function renderGrid(rows){
  lastRenderedRows = rows.slice();
  grid.innerHTML="";
  const colContractID=headers.findIndex(h=>h.includes('contract id'));
  const colProjectName=headers.findIndex(h=>h.includes('project name'));
  const colStatus=headers.findIndex(h=>h.includes('status'));
  const colEngineer=headers.findIndex(h=>h.includes('project engineer'));
  const colLocation=headers.findIndex(h=>h.includes('location'));
  const colImage1=headers.findIndex(h=>h.includes('image 1'));

  if(rows.length===0){
    grid.innerHTML=`<div style="grid-column:1/-1;text-align:center;padding:20px;color:#777;">No data found.</div>`;
    return;
  }

  const q = (filterCombo.value||'').trim().toLowerCase();

  rows.forEach((r,idx)=>{
    if(!r || !r.join('').trim()) return;

    const card=document.createElement('div'); 
    card.className='card';
    card.dataset.rowIndex = String(idx);

    // SMALLER IMAGE
    const img=document.createElement('img');
    const link=(colImage1>=0 && r[colImage1])?String(r[colImage1]).trim():'';
    img.src=link||LOGO_FALLBACK;
    img.className='card-thumb';
    img.loading='lazy';
    img.decoding='async';
    img.onerror=()=>{img.src=LOGO_FALLBACK;};
    card.appendChild(img);

    const content=document.createElement('div'); 
    content.className='card-content';   // will be 75% via CSS

    // top row: CID + Engineer
    const top=document.createElement('div');
    top.style.display='flex';
    top.style.justifyContent='space-between';
    top.style.alignItems='baseline';

    const cidVal = (colContractID>=0 && r[colContractID]) ? String(r[colContractID]) : '';
    const engVal = (colEngineer>=0 && r[colEngineer]) ? String(r[colEngineer]) : '';

    // highlight CID
    let cidHtml = cidVal;
    if(q && cidVal.toLowerCase().includes(q)){
      cidHtml = cidVal.replace(new RegExp(q,'ig'), m=>`<mark>${m}</mark>`);
    }

    top.innerHTML = `<span class="contract-id">${cidHtml}</span><span class="engineer-name">${engVal}</span>`;
    content.appendChild(top);

    // project name (NO "Project:")
    const projVal = (colProjectName>=0 && r[colProjectName]) ? String(r[colProjectName]) : '';
    let projHtml = projVal;
    if(q && projVal.toLowerCase().includes(q)){
      projHtml = projVal.replace(new RegExp(q,'ig'), m=>`<mark>${m}</mark>`);
    }
    const projDiv = document.createElement('div');
    projDiv.innerHTML = projHtml;
    projDiv.style.marginTop = '2px';
    content.appendChild(projDiv);

    // location (NO "Location:")
    if(colLocation>=0 && r[colLocation]){
      const locVal = String(r[colLocation]);
      let locHtml = locVal;
      if(q && locVal.toLowerCase().includes(q)){
        locHtml = locVal.replace(new RegExp(q,'ig'), m=>`<mark>${m}</mark>`);
      }
      const locDiv=document.createElement('div');
      locDiv.innerHTML = locHtml;
      locDiv.style.opacity = .85;
      content.appendChild(locDiv);
    }

    // status
    const statusDiv=document.createElement('div');
    const statusText=((colStatus>=0 && r[colStatus])?String(r[colStatus]):'').trim();
    const tt=statusText.toLowerCase(); 
    let bg='#777';
    if(tt==='completed (pcma)'||tt==='pcma') bg='#2563eb';
    else if(tt==='completed') bg='#16a34a';
    else if(tt==='on-going') bg='#f97316';
    else if(tt==='100%') bg='#14b8a6';
    statusDiv.innerHTML=`<span class="status" style="background:${bg}">${statusText}</span>`;
    content.appendChild(statusDiv);

    card.appendChild(content);
    card.addEventListener('click', ()=>openDetailFromList(idx));
    grid.appendChild(card);
  });
}









/* ===== IMAGE HELPERS ===== */
function collectImageUrls(row){
  const list = [];
  for (let i = 1; i <= 60; i++){
    const ci = headers.findIndex(h => {
      const hh = String(h || '').toLowerCase();
      return hh.includes(`image ${i}`) || hh === `image${i}`;
    });
    if (ci >= 0) {
      const url = String(row[ci] || '').trim();
      if (url) list.push({ label: `Image ${i}`, url });
    }
  }
  return list;
}

/* ===== FLOATING GALLERY ===== */
function openFloatingGallery(row){
  const imgs = collectImageUrls(row);
  if(imgs.length===0){
    alert('No images available for this record.');
    return;
  }
  const cidIdx=headers.findIndex(h=>h.includes('contract id'));
  activeCID=(cidIdx>=0?row[cidIdx]:'')||'—';
  galleryItems = imgs;
  galleryIndex = 0;

  galleryThumbs.innerHTML = '';
  imgs.forEach((it, i)=>{
    const th = document.createElement('img');
    th.className='thumb'; th.src=it.url; th.alt=it.label; th.loading='lazy';
    th.addEventListener('click', (ev)=>{ ev.stopPropagation(); showGalleryIndex(i); });
    galleryThumbs.appendChild(th);
  });

  galleryCID.textContent = activeCID;
  showGalleryIndex(0);

  galleryOverlay.classList.add('show');
  document.body.classList.add('no-scroll');
}
function closeFloatingGallery(){
  galleryOverlay.classList.remove('show');
  document.body.classList.remove('no-scroll');
}
function showGalleryIndex(idx){
  if(!galleryItems.length) return;
  galleryIndex = (idx+galleryItems.length)%galleryItems.length;
  const item = galleryItems[galleryIndex];
  const img = new Image();
  img.onload = ()=>{
    galleryImg.src = item.url;
    galleryImg.alt = item.label + ' - ' + activeCID;
  };
  img.onerror = ()=>{ galleryImg.src = LOGO_FALLBACK; };
  img.src = item.url;
  galleryOpenLink.href = item.url;
  galleryCounter.textContent = `${galleryIndex+1} / ${galleryItems.length}`;
  [...galleryThumbs.children].forEach((el,i)=>el.classList.toggle('active', i===galleryIndex));
}
galleryPrev.addEventListener('click',(e)=>{e.stopPropagation();showGalleryIndex(galleryIndex-1);});
galleryNext.addEventListener('click',(e)=>{e.stopPropagation();showGalleryIndex(galleryIndex+1);});
galleryCloseBtn.addEventListener('click',()=>closeFloatingGallery());
galleryOverlay.addEventListener('click',(e)=>{if(e.target===galleryOverlay) closeFloatingGallery();});

/* ===== MODAL ===== */
function showDetail(row){
  document.body.classList.add('no-scroll');
  modalBg.classList.add('show');

  modalContent.innerHTML=''; modalButtons.innerHTML=''; modalImages.innerHTML='';
  const cidIdx=headers.findIndex(h=>h.includes('contract id'));
  modalCID.textContent=(cidIdx>=0?row[cidIdx]:'')||'—';

  const colUpload=headers.findIndex(h=>h.includes('upload pictures'));
  const colStatus=headers.findIndex(h=>h.includes('status'));
  const colSched=headers.findIndex(h=>h.includes('sched'));
  const colActual=headers.findIndex(h=>h.includes('actual'));
  const colSlip=headers.findIndex(h=>h.includes('slip'));
  const colDelay=headers.findIndex(h=>h.includes('delay'));
  let colProg=headers.findIndex(h=>h.includes('progress')); if(colProg<0) colProg=18;

  function statusColor(v){
    const t=(v||'').toLowerCase();
    if(t==='completed (pcma)'||t==='pcma') return '#2563eb';
    if(t==='completed') return '#16a34a';
    if(t==='on-going') return '#f97316';
    if(t==='100%') return '#14b8a6';
    return '#6b7280';
  }

  headers.forEach((h,i)=>{
    const raw=(h||'').trim(); const L=raw.replace(/[:]/g,'').toUpperCase(); const V=row[i]||''; if(!V) return;
    if(L.startsWith('IMAGE')||L.includes('FOLDER')||L.includes('UPLOAD PICTURES')) return;

    const HIDE_KEYS=['SCHEDULE','ACTUAL','SLIPPAGE','DELAY','PROGRESS','YEAR','CONTRACT ID','ABC','CONTRACT AMOUNT','VARIANCE','CALENDAR DAYS','(CD)','CD','NOTICE TO PROCEED','NTP','EXPIRY DATE','ORIGINAL EXPIRY DATE','REVISED EXPIRY DATE','REV. EXPIRY DATE','REV EXPIRY DATE','DATE OF COMPLETION','COMPLETION DATE','CERTIFICATE OF COMPLETION','CERTIFICATE OF ACCEPTANCE','COC','COA'];
    if(HIDE_KEYS.some(k=>L.includes(k))) {
      // will show in pair grid
    } else {
      const d=document.createElement('div'); d.className='detail-row';
      const SHORT_MAP={'PROJECT ENGINEER':'PE','PROJECT INSPECTOR':'PI','RESIDENT ENGINEER':'RE','QUANTITY ENGINEER':'QE','MATERIALS ENGINEER':'ME'};
      const ROLE_CLASS_MAP={'PROJECT ENGINEER':'project-engineer','PROJECT INSPECTOR':'project-inspector','RESIDENT ENGINEER':'resident-engineer','QUANTITY ENGINEER':'quantity-engineer','MATERIALS ENGINEER':'materials-engineer'};
      let displayLabel=L;
      if(SHORT_MAP[L]){ displayLabel=SHORT_MAP[L]; d.classList.add('compact'); }
      const CENTER_SET=new Set(['PROJECT NAME','LOCATION','CONTRACTOR','REMARKS','LAST BILLING']);
      if(CENTER_SET.has(L)) d.classList.add('center-row');

      if(L==='STATUS'){
        const sv=(colStatus>=0?row[colStatus]:V)||'';
        d.innerHTML=`<span class="detail-label">${L}:</span><span class="detail-value status-badge" style="background:${statusColor(sv)}">${sv}</span>`;
      }else{
        d.innerHTML=`<span class="detail-label">${displayLabel}:</span><span class="detail-value ${ROLE_CLASS_MAP[L]||''}">${V}</span>`;
      }
      modalContent.appendChild(d);
    }

    if(L==='CONTRACTOR'){
      const abcIdx = findCol('abc','approved budget for the contract');
      const amtIdx = findCol('contract amount','amount');
      const revAmtIdx = findCol('revised contract amount','rev. contract amount','rev contract amount');
      const cdIdx = findCol('cd','calendar days');
      const revCdIdx = findCol('rev cd','revised cd','revised calendar days');
      const ntpIdx = findCol('notice to proceed','ntp');
      const expIdx = findCol('expiry date','original expiry date');          
      const revExpIdx = findCol('rev. expiry date','revised expiry date','rev expiry date');  
      const docIdx = findCol('date of completion','completion date','doc');
      const cocIdx = findCol('certificate of completion','cert of completion','coc');
      const coaIdx = findCol('certificate of acceptance','cert of acceptance','coa');

      const abcV = abcIdx>-1?row[abcIdx]:'';
      const amtV = amtIdx>-1?row[amtIdx]:'';
      const revAmtV = revAmtIdx>-1?row[revAmtIdx]:'';
      const cdV = cdIdx>-1?row[cdIdx]:'';
      const revCdV = revCdIdx>-1?row[revCdIdx]:'';
      const ntpV = ntpIdx>-1?row[ntpIdx]:'';
      const expV = expIdx>-1?row[expIdx]:'';
      const revExpV = revExpIdx>-1?row[revExpIdx]:'';
      const docV = docIdx>-1?row[docIdx]:'';
      const cocV = cocIdx>-1?row[cocIdx]:'';
      const coaV = coaIdx>-1?row[coaIdx]:'';

      const grid=document.createElement('div'); grid.className='pair-grid';
      function addBox(label,value,span2=false,neg=false){
        const box=document.createElement('div'); box.className='pair-box' + (span2?' span-2':'');
        const l=document.createElement('span'); l.className='pair-label'; l.textContent=label;
        const v=document.createElement('span'); v.className='pair-value'; if(neg) v.classList.add('neg'); v.textContent=value||'—';
        box.appendChild(l); box.appendChild(v); grid.appendChild(box);
      }
      addBox('ABC', abcV);
      addBox('Contract Amount', amtV);
      addBox('Rev. Contract Amount', revAmtV);
      { const __vIdx = findCol('variance'); const __vRaw = __vIdx>-1?row[__vIdx]:'—'; const __vNeg = (parseMoney(__vRaw)??0) < 0; addBox('Variance', __vRaw||'—', false, __vNeg); }
      addBox('CD', cdV);
      addBox('Rev. CD', revCdV);
      addBox('NTP', ntpV);
      addBox('Expiry Date', expV);
      addBox('Rev. Expiry Date', revExpV);
      addBox('Date of Completion', docV);
      addBox('Certificate of Completion', cocV);
      addBox('Certificate of Acceptance', coaV);

      modalContent.appendChild(grid);
    }

    if(L==='STATUS'){
      const schedNum=toPct((colSched>=0&&row[colSched])?row[colSched]:'0%',0);
      const actualNum=toPct((colActual>=0&&row[colActual])?row[colActual]:'0%',0);
      const slipNum=toPct((colSlip>=0&&row[colSlip])?row[colSlip]:'0%',0);

      const mini=document.createElement('div'); mini.className='mini-bars';
      function makeMini(label,num,baseColor,isSlippage=false){
        const r=document.createElement('div'); r.className='mini-row';
        const lab=document.createElement('div'); lab.className='mini-label'; lab.textContent=label;
        const bar=document.createElement('div'); bar.className='mini-bar';
        const fill=document.createElement('div'); fill.className='mini-fill';
        if(isSlippage){
          const cfg=colorForSlippage(num);
          fill.style.background=cfg.bg; fill.style.color=cfg.text;
          bar.appendChild(fill); r.appendChild(lab); r.appendChild(bar); mini.appendChild(r);
          animateMiniBar(fill,num,800,(v)=>`${v.toFixed(2)}%${(cfg.sad && v<=-10)?' ☹️':''}`);
        }else{
          fill.style.background=baseColor; bar.appendChild(fill); r.appendChild(lab); r.appendChild(bar); mini.appendChild(r);
          animateMiniBar(fill,num,800,(v)=>`${v.toFixed(2)}%`);
        }
      }
      makeMini('SCHED',schedNum,'#3b82f6',false);
      makeMini('ACTUAL',actualNum,'#10b981',false);
      makeMini('SLIPPAGE',slipNum,null,true);
      modalContent.appendChild(mini);

      const progRaw=(colProg>=0&&row[colProg])?String(row[colProg]).trim():'0%';
      const delayRaw=(colDelay>=0&&row[colDelay])?String(row[colDelay]).trim():'';
      let pctNum=Math.max(0,toPct(progRaw,0));

      const wrap=document.createElement('div'); wrap.className='progress-wrap';
      const label=document.createElement('div'); label.className='progress-label'; label.textContent='Time Lapsed';
      const bar=document.createElement('div'); bar.className='progress-bar';
      const fill=document.createElement('div'); fill.className='progress-fill'; fill.textContent='0%';
      bar.appendChild(fill); wrap.appendChild(label); wrap.appendChild(bar); modalContent.appendChild(wrap);

      function colorFor(v){ if(v>100) return '#dc2626'; if(v>=100) return '#16a34a'; if(v>80) return '#f97316'; return '#60a5fa'; }
      fill.style.background=colorFor(pctNum);
      requestAnimationFrame(()=>{
        const startTime=performance.now(),duration=900,start=0,end=pctNum;
        function step(now){
          const t=Math.min(1,(now-startTime)/duration);
          const curr=start+(end-start)*t, width=Math.min(curr,100);
          fill.style.width=width+'%';
          fill.textContent=`${Math.round(curr)}%${delayRaw?' ('+delayRaw+')':''}`;
          if(t<1) requestAnimationFrame(step);
          else { fill.style.width=Math.min(end,100)+'%'; fill.style.background=colorFor(end); fill.textContent=`${Math.round(end)}%${delayRaw?' ('+delayRaw+')':''}`; }
        }
        requestAnimationFrame(step);
      });
    }
  });

  if(colUpload>=0){
    const link = String(row[colUpload]||'').trim();
    if(link && isValidUrl(link)){
      const b=document.createElement('button');
      b.id='uploadBtn'; b.textContent='Upload Picture';
      b.onclick=e=>{ e.stopPropagation(); window.open(link,'_blank','noopener'); };
      modalButtons.appendChild(b);
    }
  }
  const viewBtn=document.createElement('button');
  viewBtn.id='viewPictureBtn'; 
  viewBtn.textContent='View Picture';
  viewBtn.onclick=e=>{ e.stopPropagation(); openFloatingGallery(row); };
  modalButtons.appendChild(viewBtn);

  const presentBtn=document.createElement('button');
  presentBtn.id='presentBtn';
  presentBtn.textContent='Present (Projector Mode)';
  presentBtn.onclick=e=>{ e.stopPropagation(); openPresentation(row); };
  modalButtons.appendChild(presentBtn);

  if(collectImageUrls(row).length===0){
    const box=document.createElement('div'); 
    box.style.textAlign='center'; box.style.marginTop='12px';
    const cap=document.createElement('p'); 
    cap.textContent='No images available';
    cap.style.color='#2563eb'; cap.style.fontWeight='700'; cap.style.marginTop='8px';
    box.appendChild(cap); 
    modalImages.appendChild(box);
  }

  (function(){
    const orangeSet=new Set(['PROJECT NAME','LOCATION','CONTRACTOR','LAST BILLING','REMARKS']);
    const rows=[...modalContent.querySelectorAll('.detail-row')];
    rows.forEach(row=>{
      const labelEl=row.querySelector('.detail-label');
      if(!labelEl) return;
      const raw=(labelEl.textContent||'').replace(':','').trim().toUpperCase();
      if(orangeSet.has(raw)){
        row.classList.add('emph-orange');
        row.classList.add('center-row');
      }
    });
  })();
}
function closeModal(){ modalBg.classList.remove('show'); document.body.classList.remove('no-scroll'); }
closeModalTop.addEventListener('click',closeModal);
modalBg.addEventListener('click',e=>{ if(e.target===modalBg) closeModal(); });
window.addEventListener('keydown',(e)=>{
  if(e.key==='Escape' && modalBg.classList.contains('show')) closeModal();
  if(e.key==='ArrowRight' && modalBg.classList.contains('show')) goModal(1);
  if(e.key==='ArrowLeft' && modalBg.classList.contains('show')) goModal(-1);
});

/* ===== MODAL NAVIGATION (shared with float arrows) ===== */
function openDetailFromList(idx){
  modalNavList = lastRenderedRows.slice();
  modalNavIndex = idx;
  const row = modalNavList[modalNavIndex];
  showDetail(row);
}
function goModal(delta){
  if(!modalNavList.length) return;
  let next = modalNavIndex + delta;
  if(next<0) next=0;
  if(next>modalNavList.length-1) next=modalNavList.length-1;
  if(next===modalNavIndex) return;
  modalNavIndex = next;
  showDetail(modalNavList[modalNavIndex]);
}
modalPrevFloat.addEventListener('click',(e)=>{e.stopPropagation();goModal(-1);});
modalNextFloat.addEventListener('click',(e)=>{e.stopPropagation();goModal(1);});

/* ===== PROJECTOR MODE ===== */
function statusChipColor(t){const s=(t||'').toLowerCase().trim(); if(s==='completed (pcma)'||s==='pcma') return '#2563eb'; if(s==='completed') return '#16a34a'; if(s==='on-going') return '#f59e0b'; if(s==='100%') return '#14b8a6'; return '#64748b';}
function fmtDateSafe(x){const raw=(x||'').toString().trim(); if(!raw) return '—'; const d=new Date(raw); if(!isNaN(d)) return d.toLocaleDateString('en-US',{year:'numeric',month:'short',day:'2-digit'}); return raw;}
function openPresentation(row){
  presentState.row=row;
  const cidIdx=headers.findIndex(h=>h.includes('contract id'));
  const projIdx=headers.findIndex(h=>h.includes('project name'));
  const amtIdx=headers.findIndex(h=>h.includes('contract amount'));
  const revAmtIdx=headers.findIndex(h=>h.includes('rev. contract amount','revised contract amount','rev contract amount'));
  const contIdx=headers.findIndex(h=>h.includes('contractor'));
  const statIdx=headers.findIndex(h=>h.includes('status'));
  const ntpIdx=headers.findIndex(h=>h.includes('notice to proceed','ntp'));
  const expIdx=headers.findIndex(h=>h.includes('expiry date','original expiry date'));
  const revIdx=headers.findIndex(h=>h.includes('rev. expiry date','revised expiry date','rev expiry date'));
  presentCID.textContent = cidIdx>-1 ? (row[cidIdx]||'—') : '—';
  presentProj.textContent = projIdx>-1 ? (row[projIdx]||'—') : '—';
  presentContractor.textContent = contIdx>-1 ? (row[contIdx]||'—') : '—';
  const amtRaw = amtIdx>-1 ? row[amtIdx] : '';
  const revRaw = revAmtIdx>-1 ? row[revAmtIdx] : '';
  const amtNum = parseMoney(amtRaw); const revNum = parseMoney(revRaw);
  presentAmt.textContent = amtNum!=null?fmtPHP(amtNum):(amtRaw||'—');
  presentRevAmt.textContent = revNum!=null?fmtPHP(revNum):(revRaw||'—');
  presentNTP.textContent = fmtDateSafe(ntpIdx>-1 ? row[ntpIdx] : '');
  presentExpiry.textContent = fmtDateSafe(expIdx>-1 ? row[expIdx] : '');
  presentRevExpiry.textContent = fmtDateSafe(revIdx>-1 ? row[revIdx] : '');
  const remIdx = findCol('remarks');
  presentRemarks.textContent = remIdx>-1 ? (row[remIdx]||'—') : '—';
  const st = statIdx>-1 ? (row[statIdx]||'—') : '—';
  presentStatusChip.textContent = st;
  presentStatusChip.style.background = statusChipColor(st);

  const colSched=headers.findIndex(h=>h.includes('sched'));
  const colActual=headers.findIndex(h=>h.includes('actual'));
  const colSlip=headers.findIndex(h=>h.includes('slip'));
  const s=toPct(colSched>-1?row[colSched]:'0%');
  const a=toPct(colActual>-1?row[colActual]:'0%');
  const l=toPct(colSlip>-1?row[colSlip]:'0%');
  const sEl=document.getElementById('pMiniSched');
  const aEl=document.getElementById('pMiniActual');
  const lEl=document.getElementById('pMiniSlip');
  sEl.style.background='#3b82f6'; animateMiniBar(sEl,s,800,v=>`${v.toFixed(2)}%`);
  aEl.style.background='#10b981'; animateMiniBar(aEl,a,800,v=>`${v.toFixed(2)}%`);
  const cfg=colorForSlippage(l); lEl.style.background=cfg.bg; lEl.style.color=cfg.text; animateMiniBar(lEl,l,800,v=>`${v.toFixed(2)}%${(cfg.sad && v<=-10)?' ☹️':''}`);

  presentSlides.innerHTML=''; presentThumbs.innerHTML='';
  presentState.items = collectImageUrls(row);
  if(!presentState.items.length){
    const sld=document.createElement('div'); sld.className='present-slide active'; sld.innerHTML=`<img src="${LOGO_FALLBACK}" alt="No image">`; presentSlides.appendChild(sld);
    presentCounter.textContent='0 / 0';
  }else{
    presentState.items.forEach((it,i)=>{
      const sld=document.createElement('div'); sld.className='present-slide'+(i===0?' active':''); sld.innerHTML=`<img src="${it.url}" alt="${it.label}">`; presentSlides.appendChild(sld);
      const th=document.createElement('img'); th.className='present-thumb'+(i===0?' active':''); th.src=it.url; th.alt=it.label; th.onclick=()=>showPresentIndex(i); presentThumbs.appendChild(th);
    });
    presentCounter.textContent=`1 / ${presentState.items.length}`;
  }

  presentState.index=0;
  presentOverlay.classList.add('show');
  document.body.classList.add('no-scroll');
  stopPresentAuto();
  startPresentAuto();
}
function showPresentIndex(i){
  if(!presentState.items.length) return;
  const N=presentState.items.length;
  presentState.index=(i%N+N)%N;
  [...presentSlides.children].forEach((el,idx)=>el.classList.toggle('active', idx===presentState.index));
  [...presentThumbs.children].forEach((el,idx)=>el.classList.toggle('active', idx===presentState.index));
  presentCounter.textContent=`${presentState.index+1} / ${N}`;
}
function startPresentAuto(){
  if(presentState.timer || !presentState.items.length) return;
  presentState.timer=setTimeout(function tick(){ showPresentIndex(presentState.index+1); presentState.timer=setTimeout(tick,presentState.delay); },presentState.delay);
  presentPlay.textContent='Pause';
}
function stopPresentAuto(){
  if(presentState.timer){ clearTimeout(presentState.timer); presentState.timer=null; }
  presentPlay.textContent='Play';
}
presentPrev.addEventListener('click',()=>showPresentIndex(presentState.index-1));
presentNext.addEventListener('click',()=>showPresentIndex(presentState.index+1));
presentPlay.addEventListener('click',()=>{ presentState.timer?stopPresentAuto():startPresentAuto(); });
presentOpen.addEventListener('click',()=>{ if(presentState.items.length){ window.open(presentState.items[presentState.index].url,'_blank','noopener'); } });
presentClose.addEventListener('click',()=>{ stopPresentAuto(); presentOverlay.classList.remove('show'); document.body.classList.remove('no-scroll'); });
window.addEventListener('keydown',(e)=>{
  if(!presentOverlay.classList.contains('show')) return;
  if(e.key==='Escape'){ presentClose.click(); }
  else if(e.key==='ArrowRight'){ showPresentIndex(presentState.index+1); }
  else if(e.key==='ArrowLeft'){ showPresentIndex(presentState.index-1); }
});

loadData();
if('serviceWorker' in navigator){ navigator.serviceWorker.register('service-worker.js').catch(console.error); }
</script>
</body>
</html>
